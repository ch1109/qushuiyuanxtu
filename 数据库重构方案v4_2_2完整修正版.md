# 售水机平台 - 重构后数据库表清单（DDD优化版 v4.2.2完整修正版 - 物理拆分完成）

> **总计：56张数据表** | 从99张精简至56张(-43%) | 8个领域聚合 | 遵循DDD+3NF+三大黄金法则  
> **v4.2版本更新**: 执行物理拆分(✅ user表拆分、✅ order_item拆分、✅ 统计表优化、分表预案、软删除)
> **v4.2.1修正版更新**: 水币整数化、删除充值审批流程、补充数字员工工具、优化支付方式说明
> **v4.2.2修正版更新**: 补充库存流水表、明确水质监控实现方式、优化租赁归还记录说明、补充合伙人账号体系说明

---

## 📋 目录

1. 用户领域 (8张表) [✅ 必修: 拆分user/wallet/token - v4.2物理拆分完成]
2. 设备领域 (9张表)
3. 订单领域 (7张表) [✅ 必修: 拆分order/order_item - v4.2完成]
4. 合伙人领域 (7张表)
5. 租赁领域 (3张表)
6. 商品领域 (6张表) [✅ 必修: 拆分order/order_item - v4.2物理拆分完成 + 补充库存流水表]
7. 财务领域 (4张表)
8. 营销领域 (5张表)
9. 平台基础设施 (8张表) [✅ 优化: 统计表已添加核心列]

---

## 🎯 重构设计原则

### 一、领域驱动设计(DDD)聚合根划分

| 聚合根 | 边界定义 | 核心实体 |
|-------|---------|---------|
| User | 用户全生命周期 | 账户、钱包、VIP、银行卡 |
| Device | 设备全生命周期 | 设备、水质、指令、故障 |
| Order | 交易全生命周期 | 订单、支付、退款 |
| Partner | 合伙人全生命周期 | 申请、绑定、分润 |
| Rental | 租赁全生命周期 | 产品、订单、归还 |
| Product | 商品全生命周期 | 商品、SKU、佣金 |
| Wallet | 财务账户生命周期 | 促销账户、流水 |
| Marketing | 营销活动生命周期 | 活动、海报、红包 |

### 二、三大黄金法则应用

| 法则 | 应用场景 | 决策结果 |
|-----|---------|---------|
| **生命周期法则** | 用户 vs 订单 | 分离（用户永久，订单按需创建）|
| **1对N法则** | 用户 vs 银行卡 | 银行卡1:1→合并；收货地址1:N→分离 |
| **冷热分离法则** | 设备状态 vs 设备配置 | 实时状态分离；配置用JSON合并 |

### 三、并发控制与安全策略（v4.1新增）

| 场景 | 策略 | 保障机制 | 优先级 |
|-----|------|---------|--------|
| UID生成 | 序列号表+悲观锁 | 防重复、支持高并发 | P0上线必须 |
| 三账户扣费 | 乐观锁+存储过程 | balance_lock_version、事务原子性 | P0上线必须 |
| 促销账户扣费 | 乐观锁+存储过程 | version字段、事务隔离 | P0上线必须 |
| 敏感信息 | AES加密+脱敏展示 | bank_info加密存储、查询时脱敏 | P0上线必须 |
| 库存扣减 | 乐观锁 | version字段 | P1完成 |

**核心原则**：
- 高频扣费操作采用乐观锁+存储过程确保原子性
- 敏感数据（银行卡）采用AES加密+脱敏JSON展示
- UID序列号采用单表集中管理+重试机制

### 四、🚨 高风险隐患修正（v4.2必须项）

#### ✅ 修正1: 用户表热点写入死锁问题【已执行物理拆分 🟢】

**原问题**: 
- wdy_user同时承担token更新（超高频）和money更新（高频）
- 两个事务争抢同一行 → 行锁竞争 → 死锁风险
- 后果: 用户登录阻塞财务扣费,或扣费事务阻塞登录

**修正方案**: 拆分成3张表（v4.2已执行）
```
原: wdy_user(包含token, money, 其他)
新: 
  ├─ wdy_user (核心身份信息:uid, mobile等) - 表1.2
  ├─ wdy_user_wallet (钱包:三账户 + balance_lock_version) - 表1.3
  └─ wdy_user_token (认证:token + expire_time) - 表1.4
```

**收益**: 
- ✅ 消除行锁竞争,支持10000+ QPS并发
- ✅ 各表独立扩展和索引优化
- ✅ token失效无需更新业务数据

#### ✅ 修正2: 订单明细JSON存储库存超卖【已执行物理拆分 🟢】

**原问题**:
- order_items存为JSON,包含多个商品的id和qty
- 库存扣减需在应用层循环处理 → 易出现中断和不一致
- 月销排行需遍历JSON → 效率极低
- 风险: 库存超卖、扣减不完全

**修正方案**: 拆分成2张表（v4.2已执行）
```
原: wdy_product_order(order_items JSON包含{product_id, qty})
新:
  ├─ wdy_product_order (去掉order_items字段) - 表6.2
  └─ wdy_order_item (订单明细:order_id, product_id, quantity, price...) - 表6.3
```

**收益**:
- ✅ 库存扣减改为批量SQL,原子性高
- ✅ 销量统计直接GROUP BY product_id,效率高
- ✅ 订单退款时精细化处理各商品

#### ✅ 修正3: 统计表JSON排序性能【已落实表结构 🟢】

**原问题**:
- metrics JSON中的字段排序无法使用B+树索引
- 场景: ORDER BY metrics->'$.income' DESC → 全表扫描
- 1000台设备查询排行榜 → 2-3秒卡死

**修正方案**: 混合设计（JSON + 核心列）
```
原: metrics JSON(包含order_count, income_amount, water_volume等)
新: metrics JSON(保留灵活扩展) 
    + order_count INT (独立列，建索引)
    + water_volume DECIMAL (独立列，建索引)
    + income_amount DECIMAL (独立列，建索引)
```

**收益**:
- ✅ 核心指标查询<100ms，完全不依赖查询缓存
- ✅ 灵活性保留，其他指标仍用JSON存储
- ✅ 后台仪表板排行榜不再卡死

#### 📋 修正4: 时间序列数据分表预案

**影响表**: wdy_device_water_log, wdy_device_quality

**问题**: 1000设备 × 24次/天 = 2.4万条/天，半年1000万条，查询变慢

**预案**: 设计时预留分表（暂不执行）
```sql
-- 创表时使用PARTITION by RANGE (YEAR_MONTH(created_at))
-- 每月一个分区，自动分表管理
```

#### 📋 修正5: 软删除字段补充

**影响表**: wdy_user, wdy_device, wdy_order（关键表）

**问题**: 只有status字段，误删后无法恢复，违反审计要求

**方案**: 关键表补充deleted_at字段
```sql
ALTER TABLE wdy_user ADD COLUMN deleted_at DATETIME DEFAULT NULL;
-- 查询时默认 WHERE deleted_at IS NULL
```

### 五、合并与拆分策略

| 策略类型 | 原表数 | 新表数 | 策略说明 |
|---------|-------|-------|---------|
| **🆕 热点拆分** | 用户(1张) | 3张 | v4.2拆分为user/wallet/token独立表,消除死锁 |
| **🆕 JSON拆分** | 商品订单(1张) | 2张 | order_items从JSON拆分为独立order_item表 |
| 配置类小表 | 省份/类型/模板等10+ | 1张 | 统一字典表 |
| 结构相似日志 | 8+张流水日志 | 3张 | 按领域合并+type区分 |
| 微信相关表 | 9张 | 2张 | 合并到平台配置 |
| 统计类表 | 5张 | 1张 | 统一统计表+维度字段 |

---

## 1️⃣ 用户领域 (9张表) 【v4.2物理拆分完成】

### 【v4.2 P0级关键更新 - 物理拆分执行】
| 更新项 | 说明 | 应用表 | 上线时间 |
|-------|------|-------|---------|
| ✅ 用户表物理拆分 | wdy_user拆分为3张表:user/wallet/token | 拆分表1.2-1.4 | 必须P0 |
| 🆕 UID序列号集中管理 | 新增wdy_uid_sequence表,支持高并发UID生成 | 新表1.1 | 必须P0 |
| 🔄 三账户扣费并发控制 | wdy_user_wallet增加balance_lock_version乐观锁 | 修改1.3 | 必须P0 |
| 🔄 敏感数据加密 | bank_info改为AES加密存储+脱敏JSON | 修改1.2 | 必须P0 |
| 🔄 水币整数化 | 三账户水币字段改为INT类型,按整数扣费 | 修改1.3/1.6 | 必须P0 |

**拆分收益**:
- ✅ 消除热点写入死锁: 登录(token表)和扣费(wallet表)不再争抢同一行锁
- ✅ 支持10000+ QPS: 各表独立扩展和索引优化
- ✅ 数据独立演进: 三表可独立选择存储引擎(如token表可用内存表)

---

### 1.1 wdy_uid_sequence (UID序列号表) 🆕 P0级
**用途**: 集中管理各省份UID序列号，确保高并发下的唯一性
**关键特性**: 采用悲观锁+乐观锁双锁策略，支持自动重试机制
**使用场景**: 用户注册时调用sp_generate_uid存储过程

| 字段名 | 字段类型 | 说明 | 约束 |
|-------|--------|------|------|
| id | INT | 记录ID | 主键自增 |
| province_code | CHAR(2) | 省份代码 | 唯一索引(如GD) |
| province_name | VARCHAR(50) | 省份名称 | 非空 |
| current_sequence | INT | 当前序列号 | 范围0-999999 |
| max_sequence | INT | 最大序列号 | 默认999999 |
| version | INT | 乐观锁版本 | 并发控制 |
| last_generated_at | DATETIME | 最后生成时间 | 可空 |
| created_at | DATETIME | 创建时间 | 自动时间戳 |
| updated_at | DATETIME | 更新时间 | 自动时间戳 |

**核心机制**：
- UID格式：省份代码(2位) + 序列号(6位，左补零)，如GD000001
- 生成流程：事务中先悲观锁查询，再乐观锁更新，支持3次重试
- 防溢出：当序列号达到max_sequence时返回错误，需迁移到新省份代码
- 并发吞吐：单表支持高频并发生成（MySQL支持QPS 2000+）

**相关存储过程**: sp_generate_uid（具体实现见技术附录）

---

### 1.2 wdy_user (用户核心身份表) ⭐核心表 【v4.2物理拆分】
**用途**: 用户核心身份信息,读多写少
**拆分策略**: 从原用户表拆分出钱包和认证信息,避免行锁竞争
**v4.2重要变更**: 执行物理拆分,钱包和token已移至独立表

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 用户ID（主键） | 系统生成 |
| uid | CHAR(8) | 用户唯一标识(如GD123456) | UID序列号表生成 |
| mobile | VARCHAR(20) | 手机号(唯一索引) | 用户注册 |
| nickname | VARCHAR(50) | 昵称 | 用户输入/微信授权 |
| avatar | VARCHAR(255) | 头像URL | 用户上传/微信头像 |
| **--- 累计统计(冷数据) ---** ||||
| total_stats | JSON | 累计统计JSON | 系统计算 |
| **--- VIP信息 ---** ||||
| vip_status | TINYINT | VIP状态(0否1是) | 购买VIP |
| vip_start_time | INT(10) | VIP开始时间戳 | 购买记录 |
| vip_end_time | INT(10) | VIP结束时间戳 | 系统计算 |
| **--- 角色标签 ---** ||||
| is_debugging | TINYINT | 调试员标记 | 后台分配 |
| is_management_partner | TINYINT | 管理合伙人标记 | 后台分配 |
| parent_id | BIGINT | 推荐人ID | 注册时记录 |
| **--- 🆕 银行卡信息(加密) ---** ||||
| bank_info_encrypted | VARBINARY(1024) | 银行卡信息(AES加密) | 用户绑定(加密) |
| bank_info_masked | JSON | 银行卡脱敏信息(展示用) | 加密后生成脱敏版 |
| **--- 推广素材 ---** ||||
| qr_image | VARCHAR(255) | 推广二维码 | 系统生成 |
| poster_image | VARCHAR(255) | 推广海报 | 系统生成 |
| **--- 软删除 ---** ||||
| deleted_at | DATETIME | 删除时间(软删除) | 删除时记录 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**total_stats JSON结构**:
```json
{
  "_schema_version": "1.0",
  "recharge_total": 10000.00,
  "give_total": 2000.00,
  "reward_total": 500.00,
  "water_total_liters": 1500.50,
  "order_count": 200
}
```

**bank_info_masked JSON结构（查询展示用,已脱敏）**:
```json
{
  "_schema_version": "1.0",
  "realname": "张三",
  "bank_name": "工商银行",
  "bank_card": "6222****1234",
  "idcard": "440***1234",
  "alipay_code": "138****8888"
}
```

**安全机制说明**:
- bank_info_encrypted: AES加密存储,应用层进行加解密,数据库层不可见明文
- bank_info_masked: 脱敏后的JSON,前端展示和日志记录时使用
- 操作流程: 用户绑定时→原始数据→加密存储to bank_info_encrypted + 生成脱敏版to bank_info_masked

**索引设计**:
```sql
CREATE UNIQUE INDEX idx_uid ON wdy_user(uid);
CREATE UNIQUE INDEX idx_mobile ON wdy_user(mobile);
CREATE INDEX idx_parent ON wdy_user(parent_id);
CREATE INDEX idx_vip ON wdy_user(vip_status, vip_end_time);
CREATE INDEX idx_deleted ON wdy_user(deleted_at);
```

**设计说明**:
- ✅ 读多写少: 用户基础信息更新频率低,适合缓存
- ✅ 关联查询: 通过user_id关联钱包表和token表
- ✅ 软删除: 保留deleted_at字段,支持数据恢复和审计
- ✅ UID生成: 由wdy_uid_sequence序列号表生成,支持高并发

---

### 1.3 wdy_user_wallet (用户钱包表) ⭐核心表 【v4.2新增】
**用途**: 用户资金账户,高频扣费热点表
**拆分理由**: 与身份信息分离,避免登录和扣费的行锁竞争
**并发策略**: 使用balance_lock_version乐观锁 + 存储过程确保原子性

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| user_id | BIGINT | 用户ID（主键） | 关联wdy_user |
| **--- 三账户钱包(水币按整数计费) ---** ||||
| recharge_coin | INT | 充值水币(可退款,整数) | 充值订单 |
| give_coin | INT | 赠送水币(不可退,整数) | 注册/套餐赠送 |
| reward_coin | INT | 奖励水币(不可退,整数) | 营销活动 |
| money | DECIMAL(10,2) | 现金余额(分润提现) | 合伙人分润 |
| **--- 并发控制(P0必须) ---** ||||
| balance_lock_version | INT | 余额锁版本号(乐观锁) | 扣费时递增 |
| **--- 支付安全 ---** ||||
| pay_password | VARCHAR(255) | 支付密码(加密) | 用户设置 |
| pay_salt | VARCHAR(255) | 密码盐值 | 系统生成 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**索引设计**:
```sql
CREATE PRIMARY KEY idx_user ON wdy_user_wallet(user_id);
CREATE INDEX idx_balance_lock ON wdy_user_wallet(user_id, balance_lock_version);
```

**并发扣费流程**:
```sql
-- 调用存储过程执行原子性扣费
CALL sp_deduct_water_coins(
  @user_id, 
  @deduct_amount, 
  @coin_type, -- 'recharge'/'give'/'reward'
  @current_version, 
  @result
);
-- @result: 0=成功, 1=余额不足, 2=版本冲突需重试
```

**设计说明**:
- ✅ 热点分离: 高频扣费操作不影响用户基础信息查询
- ✅ 乐观锁: balance_lock_version支持10000+ QPS并发扣费
- ✅ 原子性: 配合存储过程sp_deduct_water_coins确保三账户扣费原子性
- ✅ 重试机制: 版本冲突时应用层自动重试(最多3次)

---

### 1.4 wdy_user_token (用户认证表) 【v4.2新增】
**用途**: 用户登录认证令牌,超高频更新
**拆分理由**: token刷新频率极高,与用户信息和钱包完全解耦
**更新频率**: 每次登录、每次token刷新(7天内活跃用户每日多次)

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| user_id | BIGINT | 用户ID（主键） | 关联wdy_user |
| token | VARCHAR(64) | 登录令牌 | 登录生成 |
| token_expire | INT(10) | 令牌过期时间戳 | 登录计算 |
| platform_type | VARCHAR(20) | 平台类型 | MINIAPP/APP/H5 |
| device_info | VARCHAR(255) | 设备信息 | 客户端上报 |
| last_active_time | DATETIME | 最后活跃时间 | token使用时更新 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**索引设计**:
```sql
CREATE PRIMARY KEY idx_user ON wdy_user_token(user_id);
CREATE UNIQUE INDEX idx_token ON wdy_user_token(token);
CREATE INDEX idx_expire ON wdy_user_token(token_expire);
```

**Token验证流程**:
```sql
-- 1. 通过token查询(走索引)
SELECT user_id, token_expire FROM wdy_user_token WHERE token = ? LIMIT 1;

-- 2. 验证过期时间
IF token_expire > UNIX_TIMESTAMP() THEN
  -- token有效,更新最后活跃时间
  UPDATE wdy_user_token SET last_active_time = NOW() WHERE user_id = ?;
END IF;
```

**设计说明**:
- ✅ 完全解耦: token更新不影响用户信息和钱包表
- ✅ 高频优化: 独立表支持token表的特殊优化(如内存表)
- ✅ 过期清理: 定时任务清理过期token(token_expire < 当前时间)
- ✅ 多端支持: platform_type区分小程序、APP、H5等不同端

---

### 1.5 wdy_user_coin_log (水币流水表) ⭐核心表
**用途**: 记录所有水币变动（充值、消费、赠送、奖励、补录）
**合并来源**: wdy_user_money_log (结构优化)

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 流水ID（主键） | 系统生成 |
| user_id | BIGINT | 用户ID | 操作用户 |
| log_type | VARCHAR(30) | 流水类型 | 业务类型 |
| coin_type | VARCHAR(20) | 水币类型 | recharge/give/reward |
| amount | INT | 变动水币数(+/-,整数) | 业务计算 |
| balance_before | INT | 变动前余额(整数) | 系统记录 |
| balance_after | INT | 变动后余额(整数) | 系统计算 |
| related_id | BIGINT | 关联业务ID | 订单ID/活动ID等 |
| related_type | VARCHAR(30) | 关联业务类型 | ORDER/ACTIVITY/REFILL |
| memo | VARCHAR(255) | 流水说明 | 系统生成 |
| **--- 人工补录审计字段 ---** ||||
| operator_id | VARCHAR(32) | 操作人ID(补录时) | 管理员ID |
| operator_name | VARCHAR(50) | 操作人姓名 | 管理员姓名 |
| refill_reason | TEXT | 补录原因 | 后台必填 |
| approval_id | BIGINT | 审批单ID | 关联审批表 |
| created_at | DATETIME | 创建时间 | 系统生成 |

**log_type枚举**:
- `RECHARGE` - 充值
- `CONSUME` - 消费
- `GIFT` - 赠送
- `REWARD` - 奖励
- `REFILL` - 人工补录
- `REFUND` - 退款
- `TRANSFER` - 转让

**索引设计**:
```sql
CREATE INDEX idx_user_time ON wdy_user_coin_log(user_id, created_at DESC);
CREATE INDEX idx_type ON wdy_user_coin_log(log_type, coin_type);
CREATE INDEX idx_related ON wdy_user_coin_log(related_type, related_id);
```

---

### 1.6 wdy_user_promotion_log (推广关系表)
**用途**: 记录用户推荐关系链
**保留理由**: 1:N关系（一个推荐人可推荐多人）

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID | 系统生成 |
| user_id | BIGINT | 被推广人ID | 新用户ID |
| promoter_id | BIGINT | 推广人ID | 推荐人ID |
| level | TINYINT | 推广层级(1=直推) | 系统计算 |
| created_at | DATETIME | 创建时间 | 注册时间 |

---

### 1.7 wdy_feedback (用户反馈表)
**用途**: 用户反馈工单
**保留理由**: 独立生命周期

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 反馈ID | 系统生成 |
| user_id | BIGINT | 用户ID | 提交用户 |
| content | TEXT | 反馈内容 | 用户输入 |
| images | JSON | 图片列表JSON | 用户上传 |
| reply | TEXT | 回复内容 | 客服回复 |
| status | VARCHAR(20) | 状态 | PENDING/REPLIED/CLOSED |
| handler_id | BIGINT | 处理人ID | 客服ID |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

---

### 1.8 wdy_balance_refill_approval (资金补录审批表)
**用途**: 资金补录二次审批
**保留理由**: 独立生命周期（审批流程）

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 审批ID | 系统生成 |
| user_id | BIGINT | 补录对象用户ID | 目标用户 |
| refill_amount | DECIMAL(10,2) | 补录金额 | 后台输入 |
| coin_type | VARCHAR(20) | 水币类型 | 后台选择 |
| refill_type | VARCHAR(50) | 补录类型 | DATA_RECOVERY/COMPENSATION |
| reason | TEXT | 补录原因 | 后台必填 |
| applicant_id | VARCHAR(32) | 申请人ID | 超管ID |
| applicant_name | VARCHAR(50) | 申请人姓名 | 超管姓名 |
| approver_id | VARCHAR(32) | 审批人ID | 审批超管ID |
| approver_name | VARCHAR(50) | 审批人姓名 | 审批超管姓名 |
| status | VARCHAR(20) | 状态 | PENDING/APPROVED/REJECTED |
| approval_remark | TEXT | 审批意见 | 审批人输入 |
| created_at | DATETIME | 申请时间 | 系统生成 |
| approved_at | DATETIME | 审批时间 | 审批时记录 |

---

---

## 2️⃣ 设备领域 (9张表) 【v4.1增强】

### 【v4.1 P1级补充】
| 新增表 | 说明 | 上线时间 |
|-------|------|---------|
| 🆕 wdy_device_price_history | 设备价格变更历史表，审计每次价格调整 | P1二阶段 |
| 🆕 wdy_device_maintenance | 设备维护记录表，完整记录设备维护历史 | P1二阶段 |

---

### 2.1 wdy_device (设备聚合根) ⭐核心表
**用途**: 设备完整信息，包含基础信息、位置、IoT配置、计费、促销
**合并来源**: wdy_water_station + wdy_map_config(配置类用JSON)

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 设备ID（主键） | 系统生成 |
| station_no | VARCHAR(50) | 设备编号 | 出厂编号 |
| name | VARCHAR(100) | 设备名称 | 后台输入 |
| **--- 位置信息 ---** ||||
| province | VARCHAR(50) | 省份 | 地址解析 |
| city | VARCHAR(50) | 城市 | 地址解析 |
| district | VARCHAR(50) | 区县 | 地址解析 |
| address | VARCHAR(500) | 详细地址 | 后台输入/地图选点 |
| lng | DECIMAL(11,8) | 经度 | 地图API |
| lat | DECIMAL(10,8) | 纬度 | 地图API |
| **--- IoT配置(合并) ---** ||||
| iot_config | JSON | IoT配置JSON | 阿里云IoT |
| **--- 状态信息 ---** ||||
| status | VARCHAR(20) | 设备状态 | NORMAL/FAULT/MAINTENANCE |
| online_status | TINYINT | 在线状态(0离线1在线) | 心跳监测 |
| switch_status | TINYINT | 开关状态 | 设备上报 |
| last_heartbeat | DATETIME | 最后心跳时间 | 设备上报 |
| **--- 计费配置 ---** ||||
| charging_config | JSON | 计费标准JSON | 后台配置 |
| **--- 促销配置 ---** ||||
| is_promotion | TINYINT | 促销模式开关 | 后台设置 |
| sponsor_uid | CHAR(8) | 买单人UID | 后台绑定 |
| promotion_config | JSON | 促销配置JSON | 后台配置 |
| **--- 报警配置 ---** ||||
| last_alert_time | DATETIME | 最后报警时间 | 报警系统 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**iot_config JSON结构**:
```json
{
  "productKey": "xxx",
  "deviceSecret": "xxx",
  "topic": "xxx"
}
```

**charging_config JSON结构**:
```json
{
  "mode": "VOLUME",
  "price_per_liter": 0.5,
  "vip_discount": 0.5,
  "free_quota": 0
}
```

**promotion_config JSON结构**:
```json
{
  "name": "企业福利活动",
  "start_time": 1703001600,
  "end_time": 1704211200,
  "daily_limit": 100
}
```

**索引设计**:
```sql
CREATE UNIQUE INDEX idx_station_no ON wdy_device(station_no);
CREATE INDEX idx_location ON wdy_device(province, city, district);
CREATE INDEX idx_status ON wdy_device(status, online_status);
CREATE INDEX idx_promotion ON wdy_device(is_promotion, sponsor_uid);
```

---

### 2.2 wdy_device_water_log (取水流水表) ⭐核心表
**用途**: 记录每次取水流水
**保留理由**: 1:N关系，独立生命周期

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 流水ID | 系统生成 |
| device_id | BIGINT | 设备ID | 取水设备 |
| user_id | BIGINT | 用户ID | 取水用户 |
| order_id | BIGINT | 订单ID | 关联订单 |
| water_quantity | DECIMAL(10,2) | 水量(升) | 脉冲计算 |
| pulse_data | JSON | 脉冲数据JSON | 设备上报 |
| status | TINYINT | 状态(0进行中/1完成) | 设备上报 |
| created_at | DATETIME | 开始时间 | 扫码时间 |
| finished_at | DATETIME | 完成时间 | 设备上报 |

**pulse_data JSON结构**:
```json
{
  "start_pulse": 0,
  "end_pulse": 1500,
  "pulse_rate": 100
}
```

---

### 2.3 wdy_device_quality (设备水质表)
**用途**: 设备实时和历史水质数据
**合并来源**: wdy_water_quality_realtime + wdy_device_water_quality_log
**设计策略**: 实时数据存设备表JSON,历史数据独立存储

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID | 系统生成 |
| device_id | BIGINT | 设备ID | 上报设备 |
| tds | DECIMAL(10,2) | TDS值(ppm) | TDS传感器 |
| temperature | DECIMAL(5,2) | 温度(℃) | 温度传感器 |
| turbidity | DECIMAL(10,2) | 浊度(NTU) | 浊度传感器 |
| cod | DECIMAL(10,2) | COD值 | COD传感器 |
| toc | DECIMAL(10,2) | TOC值 | TOC传感器 |
| report_time | DATETIME | 上报时间 | 设备上报 |
| created_at | DATETIME | 创建时间 | 系统生成 |

**索引设计**:
```sql
CREATE INDEX idx_device_time ON wdy_device_quality(device_id, report_time DESC);
```

**💡 水质报告与预警实现说明（v4.2.2优化）**:
- **水质检测报告**: 不建议新增表，基于本表数据动态生成PDF报告即可
- **水质异常预警**: 不建议新增表，复用 `wdy_device_fault` 故障表，设置 `fault_type='WATER_QUALITY'` 即可
- **实时数据**: wdy_device表可增加 `realtime_quality` JSON字段缓存最新值，减少查询本表频率
- **去冗余设计**: 避免为相同数据建立多张表，通过类型字段(type/fault_type)区分业务场景

---

### 2.4 wdy_device_fault (设备故障表)
**用途**: 设备故障工单（含水质异常）
**保留理由**: 独立生命周期
**v4.2.2优化**: 补充水质异常类型,明确与维护记录的关联

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 故障单ID | 系统生成 |
| device_id | BIGINT | 设备ID | 故障设备 |
| fault_type | VARCHAR(50) | 故障类型 | 用户上报/系统检测 |
| fault_desc | TEXT | 故障描述 | 用户输入 |
| images | JSON | 故障图片JSON | 用户上传 |
| priority | VARCHAR(20) | 优先级 | HIGH/MEDIUM/LOW |
| status | VARCHAR(20) | 状态 | PENDING/PROCESSING/RESOLVED |
| handler_id | BIGINT | 处理人ID | 维护员ID |
| handle_result | TEXT | 处理结果 | 维护员填写 |
| created_at | DATETIME | 创建时间 | 报修时间 |
| handled_at | DATETIME | 处理时间 | 完成时间 |

**fault_type枚举（v4.2.2补充）**:
- `HARDWARE` - 硬件故障
- `WATER_QUALITY` - 水质异常（复用此表处理水质预警）
- `NETWORK` - 网络故障
- `SOFTWARE` - 软件故障
- `POWER` - 电源故障
- `OTHER` - 其他故障

**💡 业务流程优化建议（v4.2.2）**:
- **自动生成维护记录**: 当故障工单状态变为 `RESOLVED`（已解决）时，系统应自动在 `wdy_device_maintenance` 表插入一条维护记录
- **数据关联**: 维护记录的 `related_fault_id` 字段关联本表的故障单ID
- **避免重复录入**: 维护人员不需要手工在两个地方录入相同信息

---

### 2.5 wdy_device_cmd (设备指令表)
**用途**: 远程控制指令队列
**保留理由**: 独立生命周期

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 指令ID | 系统生成 |
| device_id | BIGINT | 设备ID | 目标设备 |
| cmd_type | VARCHAR(50) | 指令类型 | 后台选择 |
| cmd_params | JSON | 指令参数JSON | 后台输入 |
| status | VARCHAR(20) | 状态 | PENDING/SENT/EXECUTED/FAILED |
| result | JSON | 执行结果JSON | 设备反馈 |
| operator_id | BIGINT | 操作人ID | 管理员ID |
| created_at | DATETIME | 创建时间 | 下发时间 |
| executed_at | DATETIME | 执行时间 | 设备反馈 |

---

### 2.6 wdy_device_status_log (设备状态日志表)
**用途**: 设备状态变更历史
**保留理由**: 审计需要

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 日志ID | 系统生成 |
| device_id | BIGINT | 设备ID | 变更设备 |
| old_status | VARCHAR(20) | 原状态 | 变更前 |
| new_status | VARCHAR(20) | 新状态 | 变更后 |
| change_reason | VARCHAR(255) | 变更原因 | 系统/手动 |
| operator_id | BIGINT | 操作人ID | 管理员/系统 |
| created_at | DATETIME | 变更时间 | 系统生成 |

---

### 2.7 wdy_device_debug (调试任务表)
**用途**: 设备调试任务
**合并来源**: wdy_debugging + wdy_debugging_log

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 任务ID | 系统生成 |
| device_id | BIGINT | 设备ID | 调试设备 |
| debugger_id | BIGINT | 调试员ID | 用户ID |
| debug_type | VARCHAR(50) | 调试类型 | 后台选择 |
| debug_params | JSON | 调试参数JSON | 后台配置 |
| status | VARCHAR(20) | 状态 | PENDING/RUNNING/COMPLETED |
| result | JSON | 调试结果JSON | 设备反馈 |
| logs | JSON | 调试日志JSON | 过程记录 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| finished_at | DATETIME | 完成时间 | 系统记录 |

---

### 2.8 wdy_device_price_history (设备价格变更历史表) 🆕 P1级
**用途**: 记录每次设备计费标准调整，完整审计价格变更
**保留理由**: 历史追溯、对账核算的需要，独立生命周期

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID（主键） | 系统生成 |
| device_id | BIGINT | 设备ID | 目标设备 |
| old_pricing | JSON | 变更前计费标准 | 之前的charging_config |
| new_pricing | JSON | 变更后计费标准 | 新的charging_config |
| change_reason | VARCHAR(100) | 变更原因 | 如"季度调价"、"促销调整" |
| operator_id | BIGINT | 操作人ID | 后台管理员 |
| operator_name | VARCHAR(50) | 操作人姓名 | 管理员姓名 |
| effective_at | DATETIME | 生效时间 | 价格生效时间 |
| created_at | DATETIME | 记录时间 | 系统生成 |

**设计说明**：
- 每次调整device的charging_config时都同步记录一条历史
- 支持对账：对比某时段内用户被扣的价格是否匹配当时的device_price_history

---

### 2.9 wdy_device_maintenance (设备维护记录表) 🆕 P1级
**用途**: 记录设备的所有维护、维修、更换、清洁等操作
**保留理由**: 售后、保修、故障诊断需要完整维护历史
**v4.2.2优化**: 补充故障单关联字段,支持从故障工单自动生成

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID（主键） | 系统生成 |
| device_id | BIGINT | 设备ID | 维护设备 |
| related_fault_id | BIGINT | 关联故障单ID | 可选,来自wdy_device_fault |
| maintenance_type | VARCHAR(30) | 维护类型 | REPAIR/REPLACE/CLEAN/INSPECT |
| description | TEXT | 维护说明 | 维护人员描述 |
| parts_replaced | JSON | 更换零件JSON | 如[{name: "滤芯", sn: "xxx"}] |
| cost | DECIMAL(10,2) | 维护成本 | 费用记录 |
| operator_id | BIGINT | 维护人员ID | 后台工程师ID |
| operator_name | VARCHAR(50) | 维护人员姓名 | 工程师姓名 |
| next_maintenance_date | DATE | 下次维护日期 | 预计下次维护 |
| attachment_urls | JSON | 附件URL数组 | 维修照片等 |
| created_at | DATETIME | 维护时间 | 系统生成 |

**设计说明**：
- 设备生命周期管理中的重要记录,用于追溯设备历史、预测维护周期
- 可与wdy_device_water_log和故障表结合分析设备可靠性
- attachment_urls支持上传维修照片和凭证
- **💡 v4.2.2优化**: related_fault_id字段用于关联wdy_device_fault表,当故障工单结单时自动生成维护记录,避免重复录入

---

## 3️⃣ 订单领域 (6张表)

### 3.1 wdy_order (订单聚合根) ⭐核心表
**用途**: 所有类型订单统一表
**设计策略**: 多态表设计，用order_type区分

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 订单ID（主键） | 系统生成 |
| order_sn | VARCHAR(32) | 订单号(唯一) | 系统生成 |
| order_type | VARCHAR(30) | 订单类型 | 业务类型 |
| user_id | BIGINT | 用户ID | 下单用户 |
| **--- 金额信息 ---** ||||
| order_amount | DECIMAL(10,2) | 订单金额 | 业务计算 |
| pay_amount | DECIMAL(10,2) | 实付金额 | 支付完成 |
| discount_amount | DECIMAL(10,2) | 优惠金额 | 优惠计算 |
| **--- 支付信息 ---** ||||
| pay_type | VARCHAR(30) | 支付方式/水币类型 | 取水订单:RECHARGE_COIN/GIVE_COIN/REWARD_COIN;充值订单:WECHAT/ALIPAY |
| pay_status | TINYINT | 支付状态 | 0待付/1已付/2退款 |
| pay_time | DATETIME | 支付时间 | 支付成功 |
| **--- 订单状态 ---** ||||
| order_status | TINYINT | 订单状态 | 业务状态 |
| **--- 业务扩展(多态) ---** ||||
| biz_data | JSON | 业务数据JSON | 按类型存储 |
| **--- 促销标记 ---** ||||
| is_promotion | TINYINT | 是否促销订单 | 促销判断 |
| sponsor_uid | CHAR(8) | 买单人UID | 促销账户 |
| promotion_name | VARCHAR(100) | 促销活动名 | 活动配置 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**order_type枚举**:
- `RECHARGE` - 充值订单
- `WATER` - 取水订单
- `VIP` - VIP购买订单
- `GROUP_BUY` - 拼团订单
- `PRODUCT` - 商品订单
- `RENTAL` - 租赁订单
- `INSTALL` - 安装订单

**biz_data JSON结构示例（取水订单）**:
```json
{
  "device_id": 123,
  "water_quantity": 5.5,
  "coin_amount": 3,
  "coin_type": "GIVE_COIN",
  "deduct_details": [
    {"type": "REWARD_COIN", "amount": 1},
    {"type": "GIVE_COIN", "amount": 2}
  ]
}
```
**说明**: 
- coin_amount: 本次扣除的水币总数(整数),门关闭后统计
- coin_type: 主要使用的水币类型(RECHARGE_COIN/GIVE_COIN/REWARD_COIN)
- deduct_details: 具体扣费明细,优先级:奖励币>赠送币>充值币

**biz_data JSON结构示例（充值订单）**:
```json
{
  "meal_id": 5,
  "meal_name": "100元套餐",
  "coin_amount": 2000,
  "give_amount": 400
}
```
**说明**: coin_amount和give_amount均为整数水币

**索引设计**:
```sql
CREATE UNIQUE INDEX idx_order_sn ON wdy_order(order_sn);
CREATE INDEX idx_user_type ON wdy_order(user_id, order_type);
CREATE INDEX idx_status ON wdy_order(order_status, pay_status);
CREATE INDEX idx_time ON wdy_order(created_at DESC);
CREATE INDEX idx_promotion ON wdy_order(is_promotion, sponsor_uid);
```

---

### 3.2 wdy_order_payment (支付记录表)
**用途**: 支付网关交互记录
**合并来源**: wdy_ali_pay_log + wdy_miniapp_qr_log
**v4.2.2优化**: 补充查询性能优化建议

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID | 系统生成 |
| order_id | BIGINT | 订单ID | 关联订单 |
| order_sn | VARCHAR(32) | 订单号 | 订单号 |
| pay_channel | VARCHAR(30) | 支付渠道 | WECHAT/ALIPAY |
| transaction_id | VARCHAR(64) | 第三方交易号 | 支付网关 |
| pay_amount | DECIMAL(10,2) | 支付金额 | 支付金额 |
| pay_status | VARCHAR(20) | 支付状态 | SUCCESS/FAILED/REFUND |
| request_data | JSON | 请求数据JSON | 发送数据 |
| response_data | JSON | 响应数据JSON | 返回数据 |
| callback_data | JSON | 回调数据JSON | 异步通知 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| callback_at | DATETIME | 回调时间 | 回调时间 |

**⚠️ 查询性能优化建议（v4.2.2重要）**:
- **列表页禁止查询JSON字段**: request_data/response_data/callback_data包含大量报文数据,在列表页SELECT时严重拖慢查询速度
- **推荐查询方式**: 
  ```sql
  -- ✅ 列表页查询(只查基础字段)
  SELECT id, order_id, pay_channel, pay_amount, pay_status, created_at
  FROM wdy_order_payment
  WHERE created_at >= ? ORDER BY created_at DESC;
  
  -- ❌ 错误方式(查询所有字段包括JSON)
  SELECT * FROM wdy_order_payment; -- 性能极差!
  
  -- ✅ 详情页查询(点击详情时才查JSON)
  SELECT request_data, response_data, callback_data
  FROM wdy_order_payment
  WHERE id = ?;
  ```
- **应用场景**: 财务对账页面展示支付记录列表时,只显示基础信息,点击"查看详情"时再查询完整JSON数据
- **性能提升**: 避免查询JSON字段可将列表页查询速度从2-3秒降至50-100ms

---

### 3.3 wdy_meal (充值套餐表)
**用途**: 水币充值套餐配置
**保留理由**: 独立配置实体
**说明**: 水币标准售价0.05元/个,VIP用户五折0.025元/个

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 套餐ID | 系统生成 |
| name | VARCHAR(100) | 套餐名称 | 后台输入 |
| price | DECIMAL(10,2) | 套餐价格 | 后台输入 |
| coin_amount | INT | 充值水币数(整数) | 后台输入 |
| give_amount | INT | 赠送水币数(整数) | 后台输入 |
| vip_days | INT | 赠送VIP天数 | 后台输入 |
| is_active | TINYINT | 是否启用 | 后台管理 |
| sort_order | INT | 排序 | 后台排序 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**VIP会员权益说明**:
- 开通超级会员额外赠送2000水币(记入give_coin账户)
- VIP用户购买水币享受五折优惠(0.025元/个,普通用户0.05元/个)
- 每个区域的设备标准水价可由管理员在后台自定义设置

---

### 3.4 wdy_order_refund (退款记录表)
**用途**: 退款申请和处理记录
**保留理由**: 独立生命周期

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 退款ID | 系统生成 |
| order_id | BIGINT | 订单ID | 关联订单 |
| refund_sn | VARCHAR(32) | 退款单号 | 系统生成 |
| refund_amount | DECIMAL(10,2) | 退款金额 | 申请金额 |
| refund_reason | TEXT | 退款原因 | 用户/系统 |
| status | VARCHAR(20) | 状态 | PENDING/APPROVED/REJECTED/COMPLETED |
| handler_id | BIGINT | 处理人ID | 管理员ID |
| handle_remark | TEXT | 处理意见 | 管理员输入 |
| refund_data | JSON | 退款数据JSON | 支付网关 |
| created_at | DATETIME | 申请时间 | 系统生成 |
| handled_at | DATETIME | 处理时间 | 系统记录 |

---

### 3.5 wdy_transfer (水币转让表)
**用途**: 用户间水币转让记录
**保留理由**: 独立交易记录

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 转让ID | 系统生成 |
| from_user_id | BIGINT | 转出用户ID | 转出方 |
| to_user_id | BIGINT | 转入用户ID | 转入方 |
| amount | INT | 转让水币数(整数) | 用户输入 |
| coin_type | VARCHAR(20) | 水币类型 | recharge_coin |
| status | VARCHAR(20) | 状态 | SUCCESS/FAILED |
| remark | VARCHAR(255) | 备注 | 用户输入 |
| created_at | DATETIME | 创建时间 | 系统生成 |

---

### 3.6 wdy_withdrawals (提现申请表)
**用途**: 现金余额提现申请
**保留理由**: 独立生命周期

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 提现ID | 系统生成 |
| user_id | BIGINT | 用户ID | 申请用户 |
| amount | DECIMAL(10,2) | 提现金额 | 用户输入 |
| fee | DECIMAL(10,2) | 手续费 | 系统计算 |
| actual_amount | DECIMAL(10,2) | 实际到账 | amount-fee |
| bank_info | JSON | 收款账户JSON | 用户选择 |
| status | VARCHAR(20) | 状态 | PENDING/PROCESSING/SUCCESS/FAILED |
| handler_id | BIGINT | 处理人ID | 财务人员 |
| handle_remark | TEXT | 处理备注 | 财务填写 |
| transfer_data | JSON | 转账数据JSON | 支付网关 |
| created_at | DATETIME | 申请时间 | 系统生成 |
| handled_at | DATETIME | 处理时间 | 系统记录 |

---

## 4️⃣ 合伙人领域 (6张表)

**💡 合伙人账号体系说明（v4.2.2重要）**:

合伙人在系统中的账号架构分为两个层次：
1. **前台账号（小程序端）**: 
   - 数据表：`wdy_user` + `wdy_partner`
   - 用途：合伙人在小程序中查看自己的收益、绑定设备、使用数字员工工具
   - 登录方式：微信授权登录
   - 权限范围：只能看自己的数据

2. **后台账号（管理系统）**:
   - 数据表：`wdy_admin`
   - 用途：部分合伙人（如管理合伙人）需要登录后台系统进行审批、管理等操作
   - 登录方式：账号密码登录
   - 权限范围：根据角色配置，可查看和管理其他合伙人

**🔗 账号关联关系**:
- 如果合伙人需要登录后台，需在 `wdy_admin` 表增加一条记录，并通过 `related_partner_id` 字段关联到 `wdy_partner` 表
- 不是所有合伙人都需要后台账号，普通营销/拓展合伙人只用小程序即可
- 管理合伙人、区域合伙人等通常需要后台账号来执行审批和管理职能

**⚠️ 避免混淆**:
- PRD中的"子账号管理"指的是创建后台管理系统的账号（`wdy_admin`）
- 合伙人身份信息存储在 `wdy_partner`（关联 `wdy_user`）
- 两者通过 `related_partner_id` 建立关联，但不是同一套账号体系

---

### 4.1 wdy_partner (合伙人聚合根) ⭐核心表
**用途**: 合伙人完整信息
**合并来源**: wdy_partner_apply + wdy_partner_type配置

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 合伙人ID（主键） | 系统生成 |
| user_id | BIGINT | 关联用户ID | 申请用户 |
| partner_type | VARCHAR(30) | 合伙人类型 | 后台审核 |
| partner_level | INT | 合伙人等级 | 系统计算 |
| **--- 申请信息 ---** ||||
| apply_info | JSON | 申请资料JSON | 用户提交 |
| **--- 状态信息 ---** ||||
| status | VARCHAR(20) | 状态 | PENDING/APPROVED/REJECTED/DISABLED |
| approved_by | BIGINT | 审核人ID | 管理员ID |
| approved_at | DATETIME | 审核时间 | 审核时间 |
| **--- 分润配置 ---** ||||
| profit_config | JSON | 分润配置JSON | 后台配置 |
| **--- 统计信息 ---** ||||
| stats | JSON | 统计数据JSON | 系统计算 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 申请时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**partner_type枚举**:
- `MARKETING` - 营销合伙人 (默认分润比例10%)
- `LOCATION` - 地址合伙人 (默认分润比例20%)
- `INVESTMENT` - 出资合伙人 (默认分润比例30%)
- `MANAGEMENT` - 管理合伙人 (默认分润比例10%)
- `DISTRICT` - 区域合伙人 (默认分润比例10%)
- `EXPANSION` - 拓展合伙人 (默认分润比例10%)

**各类型合伙人职责说明**:

| 合伙人类型 | 分润比例 | 主要职责 |
|-----------|---------|---------|
| 营销合伙人 | 10% | 负责拍摄小视频、推广健康饮用水标准、营销卖水、需发起50人拼团 |
| 地址合伙人 | 20% | 提供安装地址、支持接水接电、日常保洁、需上传地址三张照片 |
| 出资合伙人 | 30% | 设备价值9.8万,直接出资1万元,成为投资合伙人 |
| 管理合伙人 | 10% | 管理审批合伙人,审批地址合理性,其他合伙人绩效考核 |
| 区域合伙人 | 10% | 拓展区域平台客户,一次性拓展100个网点以上 |
| 拓展合伙人 | 10% | 拓展单个网点,累计拓展网点50个,升级为区域合伙人 |

**apply_info JSON结构**:
```json
{
  "realname": "张三",
  "idcard": "440***1234",
  "phone": "138****8888",
  "address": "广东省广州市...",
  "company": "XX公司",
  "images": ["url1", "url2"]
}
```

**profit_config JSON结构**:
```json
{
  "profit_rate": 10,
  "settlement_type": "MONTHLY",
  "min_withdraw": 100,
  "_note": "profit_rate根据partner_type有不同默认值:营销10%、地址20%、出资30%、管理10%、区域10%、拓展10%"
}
```

**stats JSON结构**:
```json
{
  "device_count": 10,
  "total_income": 50000.00,
  "this_month_income": 5000.00,
  "team_count": 20
}
```

---

### 4.2 wdy_partner_device (合伙人设备绑定表)
**用途**: 合伙人与设备的绑定关系及设备详细信息
**保留理由**: M:N关系

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 绑定ID | 系统生成 |
| partner_id | BIGINT | 合伙人ID | 关联合伙人 |
| device_id | BIGINT | 设备ID | 关联设备 |
| **--- 设备信息 ---** ||||
| install_date | DATE | 安装日期 | 安装完成时记录 |
| install_location | VARCHAR(255) | 安装位置 | 设备地址 |
| contact_name | VARCHAR(50) | 联系人姓名 | 现场联系人 |
| contact_phone | VARCHAR(20) | 联系电话 | 现场联系人电话 |
| **--- 签约信息 ---** ||||
| contract_price | DECIMAL(10,2) | 签约价格 | 签约金额 |
| contract_period | INT | 签约周期(月) | 合约期限 |
| contract_start_date | DATE | 合约开始日期 | 合约生效日期 |
| contract_end_date | DATE | 合约结束日期 | 合约到期日期 |
| **--- 分润配置 ---** ||||
| profit_rate | DECIMAL(5,2) | 分润比例(%) | 后台配置 |
| bind_type | VARCHAR(20) | 绑定类型 | OWNER/MANAGER |
| **--- 收益统计 ---** ||||
| total_income | DECIMAL(10,2) | 累计收益 | 系统统计 |
| current_month_income | DECIMAL(10,2) | 本月收益 | 月度统计 |
| **--- 状态信息 ---** ||||
| status | VARCHAR(20) | 状态 | ACTIVE/DISABLED/EXPIRED |
| created_at | DATETIME | 绑定时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**设计说明**：
- 合伙人可在小程序中查看所有绑定设备的完整信息
- 包含设备安装信息、签约详情、收益统计等关键数据
- status字段会根据contract_end_date自动更新为EXPIRED状态
- 收益字段通过定时任务从wdy_partner_income_log表统计更新

---

### 4.3 wdy_partner_income_log (分润流水表) ⭐核心表
**用途**: 合伙人分润明细
**保留理由**: 核心财务数据

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 流水ID | 系统生成 |
| partner_id | BIGINT | 合伙人ID | 分润对象 |
| device_id | BIGINT | 设备ID | 产生设备 |
| order_id | BIGINT | 订单ID | 关联订单 |
| income_type | VARCHAR(30) | 收益类型 | WATER/PRODUCT/RENTAL |
| order_amount | DECIMAL(10,2) | 订单金额 | 订单金额 |
| profit_rate | DECIMAL(5,2) | 分润比例(%) | 配置比例 |
| income_amount | DECIMAL(10,2) | 分润金额 | 计算金额 |
| settlement_status | VARCHAR(20) | 结算状态 | PENDING/SETTLED |
| settlement_batch | VARCHAR(32) | 结算批次号 | 结算时生成 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| settled_at | DATETIME | 结算时间 | 结算时间 |

---

### 4.4 wdy_partner_withdraw (合伙人提现表)
**用途**: 合伙人分润提现
**保留理由**: 独立生命周期

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 提现ID | 系统生成 |
| partner_id | BIGINT | 合伙人ID | 申请人 |
| amount | DECIMAL(10,2) | 提现金额 | 用户输入 |
| fee | DECIMAL(10,2) | 手续费 | 系统计算 |
| actual_amount | DECIMAL(10,2) | 实际到账 | 计算金额 |
| bank_info | JSON | 收款账户JSON | 用户选择 |
| status | VARCHAR(20) | 状态 | PENDING/SUCCESS/FAILED |
| handler_id | BIGINT | 处理人ID | 财务人员 |
| transfer_data | JSON | 转账数据JSON | 支付网关 |
| created_at | DATETIME | 申请时间 | 系统生成 |
| handled_at | DATETIME | 处理时间 | 系统记录 |

---

### 4.5 wdy_partner_status_log (合伙人状态日志)
**用途**: 合伙人状态变更历史
**保留理由**: 审计需要

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 日志ID | 系统生成 |
| partner_id | BIGINT | 合伙人ID | 变更对象 |
| old_status | VARCHAR(20) | 原状态 | 变更前 |
| new_status | VARCHAR(20) | 新状态 | 变更后 |
| change_reason | VARCHAR(255) | 变更原因 | 系统/手动 |
| operator_id | BIGINT | 操作人ID | 管理员ID |
| created_at | DATETIME | 变更时间 | 系统生成 |

---

### 4.6 wdy_partner_ai_tool (合伙人数字员工工具表) 🆕
**用途**: 数字员工工具管理，支持七种合伙人类型的使用权限配置
**保留理由**: 独立功能模块，合伙人可在小程序中使用配置的数字员工工具
**说明**: 后台可添加数字员工工具接口，并为不同合伙人类型设置使用权限

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 工具ID | 系统生成 |
| tool_name | VARCHAR(100) | 工具名称 | 后台输入 |
| tool_desc | TEXT | 工具描述 | 后台输入 |
| tool_type | VARCHAR(50) | 工具类型 | AI_CHAT/AI_ANALYSIS/AI_REPORT等 |
| icon_url | VARCHAR(255) | 图标URL | 后台上传 |
| **--- API接口配置 ---** ||||
| api_endpoint | VARCHAR(500) | API接口地址 | 后台配置 |
| api_method | VARCHAR(10) | 请求方法 | GET/POST |
| api_auth | JSON | 认证配置JSON | 后台配置 |
| api_params | JSON | 参数配置JSON | 后台配置 |
| **--- 权限配置(七种合伙人类型) ---** ||||
| allowed_partner_types | JSON | 可用合伙人类型JSON | 后台选择 |
| **--- 使用限制 ---** ||||
| usage_limit | INT | 使用次数限制(0不限) | 后台配置 |
| daily_limit | INT | 每日使用限制(0不限) | 后台配置 |
| **--- 状态信息 ---** ||||
| is_active | TINYINT | 是否启用 | 后台管理 |
| sort_order | INT | 排序 | 后台排序 |
| **--- 统计信息 ---** ||||
| usage_count | INT | 累计使用次数 | 系统统计 |
| last_used_at | DATETIME | 最后使用时间 | 系统记录 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**allowed_partner_types JSON结构**:
```json
{
  "MARKETING": true,
  "LOCATION": true,
  "INVESTMENT": false,
  "MANAGEMENT": true,
  "DISTRICT": false,
  "EXPANSION": true,
  "ADDITIONAL": false
}
```
**说明**: 支持七种合伙人类型，每种类型可独立设置是否可用

**api_auth JSON结构**:
```json
{
  "type": "BEARER",
  "token": "xxx",
  "header_name": "Authorization"
}
```

**api_params JSON结构**:
```json
{
  "required_params": ["query", "user_id"],
  "optional_params": ["limit", "offset"],
  "default_values": {
    "limit": 10
  }
}
```

**设计说明**:
- 后台管理员可添加和配置各种数字员工工具的API接口
- 支持为七种合伙人类型（营销、地址、出资、管理、区域、拓展、其他）独立配置使用权限
- 合伙人在小程序中只能看到并使用自己类型被授权的工具
- 工具调用次数和频率可限制，防止滥用
- 系统记录每个工具的使用统计，便于后台分析

---

## 5️⃣ 租赁领域 (3张表)

### 5.1 wdy_rental_product (租赁产品表)
**用途**: 租赁产品配置
**保留理由**: 聚合根实体

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 产品ID | 系统生成 |
| product_name | VARCHAR(100) | 产品名称 | 后台输入 |
| product_desc | TEXT | 产品描述 | 后台输入 |
| images | JSON | 产品图片JSON | 后台上传 |
| deposit | DECIMAL(10,2) | 押金 | 后台配置 |
| rent_price | DECIMAL(10,2) | 租金(月) | 后台配置 |
| specs | JSON | 规格配置JSON | 后台配置 |
| is_active | TINYINT | 是否启用 | 后台管理 |
| sort_order | INT | 排序 | 后台排序 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

---

### 5.2 wdy_rental_order (租赁订单表) ⭐核心表
**用途**: 租赁订单
**合并来源**: wdy_rental_order + wdy_rental_payment + wdy_rental_return
**v4.2.2说明**: 归还记录存储在return_info JSON字段,不建独立表

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 订单ID | 系统生成 |
| order_sn | VARCHAR(32) | 订单号 | 系统生成 |
| user_id | BIGINT | 用户ID | 租赁用户 |
| product_id | BIGINT | 产品ID | 租赁产品 |
| partner_id | BIGINT | 合伙人ID | 服务合伙人 |
| **--- 金额信息 ---** ||||
| deposit | DECIMAL(10,2) | 押金 | 产品配置 |
| rent_price | DECIMAL(10,2) | 月租金 | 产品配置 |
| **--- 租赁信息 ---** ||||
| rent_months | INT | 租赁月数 | 用户选择 |
| start_date | DATE | 开始日期 | 合同日期 |
| end_date | DATE | 结束日期 | 计算日期 |
| address | JSON | 安装地址JSON | 用户输入 |
| **--- 状态信息 ---** ||||
| order_status | VARCHAR(20) | 订单状态 | 业务状态 |
| deposit_status | VARCHAR(20) | 押金状态 | PAID/REFUNDED/DEDUCTED |
| **--- 缴费记录(JSON数组) ---** ||||
| payment_records | JSON | 缴费记录JSON | 系统记录 |
| **--- 归还信息 ---** ||||
| return_info | JSON | 归还信息JSON | 归还时填写 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**payment_records JSON结构**:
```json
[
  {
    "period": 1,
    "amount": 100.00,
    "pay_time": "2024-01-15",
    "pay_channel": "WECHAT",
    "transaction_id": "xxx"
  }
]
```

**return_info JSON结构（v4.2.2补充完整归还流程）**:
```json
{
  "return_date": "2024-12-15",
  "return_condition": "GOOD",
  "damage_description": "滤芯需更换",
  "damage_images": ["url1", "url2"],
  "deduct_amount": 50.00,
  "deduct_reason": "滤芯损坏",
  "deposit_refund": 450.00,
  "handler_id": 123,
  "handler_name": "张三",
  "inspection_notes": "设备整体良好,仅滤芯需更换",
  "images": ["url1", "url2"]
}
```
**💡 归还流程说明（v4.2.2补充）**:
- **设备检查**: 安装员上门检查设备,拍照记录
- **损坏评估**: 记录损坏部位和程度到damage_description
- **押金处理**: 计算扣除金额(deduct_amount)和退款金额(deposit_refund)
- **状态更新**: deposit_status从PAID更新为REFUNDED或DEDUCTED
- **完整性**: 归还信息存储在return_info JSON,不建独立wdy_rental_return表

---

### 5.3 wdy_home_install (安装到家表)
**用途**: 安装服务订单
**保留理由**: 独立业务

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 安装单ID | 系统生成 |
| rental_order_id | BIGINT | 租赁订单ID | 关联订单 |
| user_id | BIGINT | 用户ID | 安装用户 |
| install_address | JSON | 安装地址JSON | 用户输入 |
| appointment_time | DATETIME | 预约时间 | 用户选择 |
| installer_id | BIGINT | 安装员ID | 系统分配 |
| status | VARCHAR(20) | 状态 | PENDING/SCHEDULED/COMPLETED |
| install_result | JSON | 安装结果JSON | 安装员填写 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| installed_at | DATETIME | 安装时间 | 完成时间 |

---

## 6️⃣ 商品领域 (6张表) 【v4.2物理拆分完成 + v4.2.2补充库存流水表】

**产品分类说明**：
本系统的商品分为三大类：
1. **租赁设备类**：包括家用设备、办公设备、工厂食堂设备三种类型
2. **服务类**：包括安装服务等增值服务
3. **售卖类**：包括手持检测工具等实体商品销售

**v4.2关键更新**：
- ✅ 订单明细物理拆分: wdy_order_item独立表,消除库存超卖风险
**v4.2.2关键更新**：
- 🆕 补充库存流水表: wdy_product_stock_log记录所有库存变动,满足财务对账需求
- ✅ 支持精确统计: 商品销量、库存扣减状态可直接SQL查询

---

### 6.1 wdy_product (商品聚合根) ⭐核心表
**用途**: 商品完整信息,支持租赁设备、服务、售卖三大类产品
**保留理由**: 聚合根实体

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 商品ID | 系统生成 |
| product_name | VARCHAR(200) | 商品名称 | 后台输入 |
| product_desc | TEXT | 商品描述 | 后台输入 |
| **--- 商品分类 ---** ||||
| product_type | VARCHAR(30) | 商品类型 | RENTAL/SERVICE/SALE |
| category_id | BIGINT | 分类ID | 后台选择 |
| sub_category | VARCHAR(50) | 子分类 | 租赁设备时使用 |
| **--- 价格库存 ---** ||||
| price | DECIMAL(10,2) | 商品价格 | 后台输入 |
| original_price | DECIMAL(10,2) | 原价 | 后台输入 |
| stock | INT | 库存 | 后台管理 |
| sales | INT | 销量 | 系统统计 |
| **--- 图片信息 ---** ||||
| images | JSON | 商品图片JSON | 后台上传 |
| **--- 分销配置 ---** ||||
| is_shareable | TINYINT | 是否可分销 | 后台设置 |
| partner_only | TINYINT | 仅合伙人分销 | 后台设置 |
| commission_rate | DECIMAL(5,2) | 佣金比例(%) | 后台配置 |
| commission_type | VARCHAR(20) | 佣金类型 | PERCENTAGE/FIXED |
| **--- 状态信息 ---** ||||
| is_active | TINYINT | 是否上架 | 后台管理 |
| sort_order | INT | 排序 | 后台排序 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**product_type枚举**:
- `RENTAL` - 租赁设备类
- `SERVICE` - 服务类
- `SALE` - 售卖类

**sub_category枚举(当product_type=RENTAL时)**:
- `HOME` - 家用设备
- `OFFICE` - 办公设备
- `FACTORY_CANTEEN` - 工厂食堂设备

**设计说明**：
- product_type字段区分三大类商品
- 租赁设备类通过sub_category字段进一步细分为家用、办公、工厂食堂三种
- 服务类商品(如安装服务)通常不需要库存管理,stock字段设置为-1表示无限库存
- 售卖类商品(如手持检测工具)需要严格的库存管理

---

### 6.2 wdy_product_order (商品订单表) ⭐核心表 【v4.2物理拆分】
**用途**: 商品购买订单头信息
**拆分策略**: order_items已拆分到wdy_order_item明细表
**v4.2重要变更**: 移除order_items JSON字段,执行物理拆分

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 订单ID | 系统生成 |
| order_sn | VARCHAR(32) | 订单号 | 系统生成 |
| user_id | BIGINT | 用户ID | 购买用户 |
| **--- 订单金额 ---** ||||
| total_amount | DECIMAL(10,2) | 订单总额 | 计算金额 |
| pay_amount | DECIMAL(10,2) | 实付金额 | 支付金额 |
| **--- 收货信息 ---** ||||
| shipping_address | JSON | 收货地址JSON | 用户选择 |
| **--- 支付状态 ---** ||||
| pay_status | TINYINT | 支付状态 | 支付流程 |
| pay_type | VARCHAR(30) | 支付方式 | 支付渠道 |
| pay_time | DATETIME | 支付时间 | 支付成功 |
| **--- 订单状态 ---** ||||
| order_status | VARCHAR(20) | 订单状态 | 业务状态 |
| **--- 物流信息 ---** ||||
| shipping_info | JSON | 物流信息JSON | 发货填写 |
| **--- 分销信息 ---** ||||
| sharer_uid | CHAR(8) | 分享人UID | 分享链接 |
| commission_status | VARCHAR(20) | 佣金状态 | PENDING/SETTLED |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**设计说明**:
- ✅ 订单明细已拆分至wdy_order_item表,通过order_id关联
- ✅ 查询订单详情需JOIN wdy_order_item表获取商品列表
- ✅ 支持精确的库存扣减和销量统计

---

### 6.3 wdy_order_item (订单明细表) ⭐核心表 【v4.2新增】
**用途**: 商品订单明细行,每个商品一行记录
**拆分理由**: 支持精确库存扣减、销量统计和退款处理
**v4.2重要变更**: 从wdy_product_order的order_items JSON拆分而来

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 明细ID | 系统生成 |
| order_id | BIGINT | 订单ID | 关联订单 |
| product_id | BIGINT | 商品ID | 购物车 |
| **--- 商品快照 ---** ||||
| product_name | VARCHAR(200) | 商品名称(快照) | 下单时商品名 |
| product_image | VARCHAR(255) | 商品图片(快照) | 下单时主图 |
| price | DECIMAL(10,2) | 商品单价(快照) | 下单时价格 |
| **--- 购买信息 ---** ||||
| quantity | INT | 购买数量 | 用户选择 |
| subtotal | DECIMAL(10,2) | 小计金额 | price * quantity |
| **--- 退款信息 ---** ||||
| refund_quantity | INT | 已退款数量 | 默认0 |
| refund_amount | DECIMAL(10,2) | 已退款金额 | 默认0.00 |
| **--- 库存管理 ---** ||||
| stock_deducted | TINYINT | 库存是否已扣减 | 0未扣1已扣 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**索引设计**:
```sql
CREATE INDEX idx_order ON wdy_order_item(order_id);
CREATE INDEX idx_product ON wdy_order_item(product_id);
CREATE INDEX idx_stock ON wdy_order_item(stock_deducted, created_at);
```

**库存扣减流程(原子性保证)**:
```sql
-- 1. 插入订单明细(未扣库存)
INSERT INTO wdy_order_item (..., stock_deducted=0) VALUES (...);

-- 2. 批量扣减库存(事务内)
START TRANSACTION;
UPDATE wdy_product SET stock = stock - ? WHERE id = ? AND stock >= ?;
UPDATE wdy_order_item SET stock_deducted = 1 WHERE id = ?;
COMMIT;

-- 3. 统计商品销量(精确)
SELECT product_id, SUM(quantity) as sales 
FROM wdy_order_item 
WHERE stock_deducted = 1 
GROUP BY product_id;
```

**设计说明**:
- ✅ 商品快照: 记录下单时的商品名称、图片、价格,防止后续修改影响历史订单
- ✅ 精确库存: stock_deducted标记确保库存扣减的幂等性
- ✅ 退款支持: refund_quantity和refund_amount支持部分退款
- ✅ 销量统计: 直接GROUP BY product_id统计,不需要解析JSON

**拆分收益**:
- ✅ 消除库存超卖: 批量SQL原子性扣减,替代应用层循环
- ✅ 查询性能提升: 月销排行直接GROUP BY,不需要遍历JSON
- ✅ 精细化退款: 支持单个商品的退款处理

---

### 6.4 wdy_product_commission (商品佣金表)
**用途**: 商品分销佣金记录
**保留理由**: 核心财务数据

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 佣金ID | 系统生成 |
| order_id | BIGINT | 商品订单ID | 关联订单 |
| product_id | BIGINT | 商品ID | 订单商品 |
| sharer_uid | CHAR(8) | 分享人UID | 分享链接 |
| buyer_uid | CHAR(8) | 购买人UID | 下单用户 |
| order_amount | DECIMAL(10,2) | 订单金额 | 订单总额 |
| commission_rate | DECIMAL(5,2) | 佣金比例(%) | 商品配置 |
| commission_amount | DECIMAL(10,2) | 佣金金额 | 计算金额 |
| status | VARCHAR(20) | 状态 | PENDING/SETTLED/CANCELLED |
| settled_at | DATETIME | 结算时间 | 结算时间 |
| created_at | DATETIME | 创建时间 | 系统生成 |

---

### 6.5 wdy_product_review (商品评价表)
**用途**: 商品评价
**保留理由**: 1:N关系

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 评价ID | 系统生成 |
| order_id | BIGINT | 订单ID | 关联订单 |
| product_id | BIGINT | 商品ID | 评价商品 |
| user_id | BIGINT | 用户ID | 评价用户 |
| rating | TINYINT | 评分(1-5) | 用户评分 |
| content | TEXT | 评价内容 | 用户输入 |
| images | JSON | 评价图片JSON | 用户上传 |
| reply | TEXT | 商家回复 | 商家回复 |
| is_anonymous | TINYINT | 是否匿名 | 用户选择 |
| status | VARCHAR(20) | 状态 | NORMAL/HIDDEN |
| created_at | DATETIME | 创建时间 | 系统生成 |

---

### 6.6 wdy_product_stock_log (商品库存流水表) 🆕 v4.2.2必须
**用途**: 记录所有商品库存变动流水,满足财务对账和审计需求
**保留理由**: 财务合规必需,防止资产流失
**v4.2.2新增**: 补充缺失的库存管理核心表

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 流水ID（主键） | 系统生成 |
| product_id | BIGINT | 商品ID | 关联商品 |
| change_type | VARCHAR(30) | 变动类型 | 流水类型 |
| change_quantity | INT | 变动数量 | 正数入库/负数出库 |
| stock_before | INT | 变动前库存 | 变动前数量 |
| stock_after | INT | 变动后库存 | 变动后数量 |
| **--- 业务关联 ---** ||||
| order_id | BIGINT | 关联订单ID | 销售出库时记录 |
| order_item_id | BIGINT | 关联订单明细ID | 精确到商品明细 |
| **--- 操作信息 ---** ||||
| operator_id | BIGINT | 操作人ID | 后台管理员ID |
| operator_name | VARCHAR(50) | 操作人姓名 | 管理员姓名 |
| reason | VARCHAR(200) | 变动原因 | 入库/出库/损耗/盘点 |
| remark | TEXT | 备注说明 | 详细说明 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |

**change_type枚举**:
- `PURCHASE_IN` - 采购入库
- `RETURN_IN` - 退货入库
- `ADJUST_IN` - 调整入库(盘盈)
- `SALE_OUT` - 销售出库
- `DAMAGE_OUT` - 损耗出库
- `ADJUST_OUT` - 调整出库(盘亏)
- `TRANSFER_IN` - 调拨入库
- `TRANSFER_OUT` - 调拨出库

**索引设计**:
```sql
CREATE INDEX idx_product ON wdy_product_stock_log(product_id, created_at DESC);
CREATE INDEX idx_order ON wdy_product_stock_log(order_id);
CREATE INDEX idx_type ON wdy_product_stock_log(change_type, created_at DESC);
```

**业务流程说明**:
1. **销售出库**: 用户下单→扣减wdy_product.stock→插入流水(change_type=SALE_OUT)
2. **采购入库**: 后台录入→增加wdy_product.stock→插入流水(change_type=PURCHASE_IN)
3. **库存盘点**: 盘点差异→调整wdy_product.stock→插入流水(change_type=ADJUST_IN/ADJUST_OUT)
4. **损耗记录**: 发现损坏→减少wdy_product.stock→插入流水(change_type=DAMAGE_OUT)

**💡 财务对账价值**:
- 所有库存变动可追溯,防止账实不符
- 支持按时间段统计入库/出库/损耗
- 结合订单表核对销售数据真实性
- 盘点时对比流水计算理论库存vs实际库存

**🚨 关键风险提示**:
- 库存变动**必须同步记录流水**,否则财务无法对账
- stock_before/stock_after字段用于双重校验,防止并发导致数据不一致
- 建议使用数据库事务确保库存变动和流水记录的原子性

---

## 7️⃣ 财务领域 (4张表) 【v4.1增强】

### 【v4.1 P0级关键更新】
| 更新项 | 说明 | 上线时间 |
|-------|------|---------|
| 🔄 促销账户扣费并发控制 | wdy_promotion_account增加version乐观锁 | 必须P0 |

---

### 7.1 wdy_promotion_account (促销账户表) ⭐核心表 【v4.1增强】
**用途**: 企业/合伙人促销账户，支持多用户高频扣费
**保留理由**: 聚合根实体
**v4.1增强**: 新增version乐观锁，确保扣费时的并发安全

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 账户ID | 系统生成 |
| uid | CHAR(8) | 促销账户UID | 系统生成 |
| account_name | VARCHAR(100) | 账户名称 | 后台输入 |
| account_type | VARCHAR(30) | 账户类型 | ENTERPRISE/PARTNER |
| **--- 余额信息 ---** ||||
| balance | DECIMAL(10,2) | 当前余额 | 充值-消费 |
| total_recharged | DECIMAL(10,2) | 累计充值 | 累计统计 |
| total_consumed | DECIMAL(10,2) | 累计消费 | 累计统计 |
| **--- 🆕 并发控制 ---** ||||
| version | INT | 余额锁版本号(乐观锁) | 扣费时递增 |
| **--- 联系信息 ---** ||||
| contact_info | JSON | 联系信息JSON | 后台输入 |
| **--- 状态信息 ---** ||||
| status | VARCHAR(20) | 状态 | ACTIVE/SUSPENDED/CLOSED |
| **--- 时间戳 ---** ||||
| created_by | VARCHAR(50) | 创建人 | 管理员 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**并发控制说明**：
- version字段用于乐观锁，扣费时采用CAS(Compare-And-Swap)模式
- 配合存储过程sp_deduct_promotion_balance使用，确保原子性
- 扣费重试机制：失败后自动重试，最多3次

**contact_info JSON结构**:
```json
{
  "person": "张三",
  "phone": "138****8888",
  "company": "XX公司",
  "address": "广东省广州市..."
}
```

---

### 7.2 wdy_promotion_log (促销消费流水表)
**用途**: 促销账户消费明细
**保留理由**: 核心财务数据

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 流水ID | 系统生成 |
| promotion_uid | CHAR(8) | 促销账户UID | 账户UID |
| log_type | VARCHAR(20) | 流水类型 | RECHARGE/CONSUME |
| device_id | BIGINT | 设备ID(消费时) | 取水设备 |
| user_uid | CHAR(8) | 实际用户UID(消费时) | 取水用户 |
| order_id | BIGINT | 订单ID | 关联订单 |
| amount | DECIMAL(10,2) | 金额 | 业务金额 |
| balance_before | DECIMAL(10,2) | 变动前余额 | 系统记录 |
| balance_after | DECIMAL(10,2) | 变动后余额 | 系统计算 |
| remark | VARCHAR(255) | 备注 | 系统说明 |
| created_at | DATETIME | 创建时间 | 系统生成 |

---

### 7.3 wdy_promotion_binding_log (促销绑定日志表)
**用途**: 设备促销绑定操作日志
**保留理由**: 审计需要

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 日志ID | 系统生成 |
| device_id | BIGINT | 设备ID | 操作设备 |
| action | VARCHAR(20) | 操作类型 | BIND/UNBIND/MODIFY |
| old_sponsor_uid | CHAR(8) | 原买单人UID | 变更前 |
| new_sponsor_uid | CHAR(8) | 新买单人UID | 变更后 |
| promotion_name | VARCHAR(100) | 促销活动名称 | 后台输入 |
| operator_id | VARCHAR(32) | 操作人ID | 管理员ID |
| operator_name | VARCHAR(50) | 操作人姓名 | 管理员姓名 |
| remark | TEXT | 操作备注 | 后台输入 |
| created_at | DATETIME | 操作时间 | 系统生成 |

---

### 7.4 wdy_settlement_batch (结算批次表)
**用途**: 分润结算批次管理
**保留理由**: 独立生命周期

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 批次ID | 系统生成 |
| batch_sn | VARCHAR(32) | 批次号 | 系统生成 |
| settlement_type | VARCHAR(30) | 结算类型 | PARTNER/COMMISSION |
| period_start | DATE | 结算周期开始 | 系统计算 |
| period_end | DATE | 结算周期结束 | 系统计算 |
| total_amount | DECIMAL(12,2) | 结算总额 | 累计金额 |
| record_count | INT | 记录数 | 累计数量 |
| status | VARCHAR(20) | 状态 | PENDING/PROCESSING/COMPLETED |
| operator_id | BIGINT | 操作人ID | 财务人员 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| completed_at | DATETIME | 完成时间 | 系统记录 |

---

## 8️⃣ 营销领域 (5张表)

### 8.1 wdy_marketing_activity (营销活动表) ⭐核心表
**用途**: 统一营销活动管理
**合并来源**: wdy_activity + wdy_red_packet + wdy_team_package

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 活动ID | 系统生成 |
| activity_type | VARCHAR(30) | 活动类型 | 后台选择 |
| activity_name | VARCHAR(100) | 活动名称 | 后台输入 |
| activity_desc | TEXT | 活动描述 | 后台输入 |
| **--- 活动配置(多态) ---** ||||
| activity_config | JSON | 活动配置JSON | 后台配置 |
| **--- 时间范围 ---** ||||
| start_time | DATETIME | 开始时间 | 后台设置 |
| end_time | DATETIME | 结束时间 | 后台设置 |
| **--- 状态信息 ---** ||||
| status | VARCHAR(20) | 状态 | DRAFT/ACTIVE/PAUSED/ENDED |
| **--- 统计信息 ---** ||||
| stats | JSON | 统计数据JSON | 系统统计 |
| **--- 时间戳 ---** ||||
| created_by | BIGINT | 创建人ID | 管理员ID |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**activity_type枚举**:
- `RED_PACKET` - 红包活动
- `GROUP_BUY` - 拼团活动
- `SIGN_IN` - 签到活动
- `INVITE` - 邀请有礼
- `FIRST_ORDER` - 首单优惠

**activity_config JSON示例（红包）**:
```json
{
  "total_amount": 10000.00,
  "single_min": 0.1,
  "single_max": 10.0,
  "total_count": 1000,
  "per_user_limit": 3
}
```

**activity_config JSON示例（拼团）**:
```json
{
  "group_size": 3,
  "original_price": 100.00,
  "group_price": 68.00,
  "time_limit_hours": 24,
  "meal_id": 5
}
```

---

### 8.2 wdy_marketing_participant (活动参与记录表)
**用途**: 用户参与活动记录
**合并来源**: wdy_activity_log + wdy_red_packet_log

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID | 系统生成 |
| activity_id | BIGINT | 活动ID | 关联活动 |
| user_id | BIGINT | 用户ID | 参与用户 |
| participate_type | VARCHAR(30) | 参与类型 | 业务类型 |
| **--- 参与详情(多态) ---** ||||
| participate_data | JSON | 参与数据JSON | 业务数据 |
| **--- 奖励信息 ---** ||||
| reward_type | VARCHAR(30) | 奖励类型 | COIN/COUPON/VIP |
| reward_amount | DECIMAL(10,2) | 奖励金额 | 业务计算 |
| reward_status | VARCHAR(20) | 发放状态 | PENDING/SENT/FAILED |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 参与时间 | 系统生成 |
| rewarded_at | DATETIME | 发放时间 | 系统记录 |

---

### 8.3 wdy_poster (海报模板表)
**用途**: 海报模板管理
**保留理由**: 独立实体

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 海报ID | 系统生成 |
| poster_name | VARCHAR(100) | 海报名称 | 后台输入 |
| poster_image | VARCHAR(255) | 海报底图URL | 后台上传 |
| template_type | VARCHAR(30) | 模板类型 | STATIC/DYNAMIC |
| **--- 动态渲染配置 ---** ||||
| dynamic_config | JSON | 动态配置JSON | 后台配置 |
| **--- 状态信息 ---** ||||
| is_active | TINYINT | 是否启用 | 后台管理 |
| sort_order | INT | 排序 | 后台排序 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**dynamic_config JSON结构**:
```json
{
  "fields": [
    {"name": "tds_value", "source": "device_quality", "position": {"x": 100, "y": 200}},
    {"name": "rank_percent", "source": "calculate", "position": {"x": 150, "y": 300}}
  ],
  "font": {"family": "微软雅黑", "size": 24, "color": "#333333"}
}
```

---

### 8.4 wdy_poster_generation (海报生成记录表)
**用途**: 用户海报生成缓存
**合并来源**: wdy_poster_log + wdy_poster_share_code + wdy_poster_generation_log

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID | 系统生成 |
| user_id | BIGINT | 用户ID | 生成用户 |
| poster_id | BIGINT | 海报模板ID | 使用模板 |
| device_id | BIGINT | 设备ID(可选) | 关联设备 |
| **--- 渲染数据 ---** ||||
| render_data | JSON | 渲染数据JSON | 动态数据 |
| **--- 生成结果 ---** ||||
| generated_url | VARCHAR(255) | 生成海报URL | OSS存储 |
| share_code | VARCHAR(50) | 分享码 | 系统生成 |
| qr_code_url | VARCHAR(255) | 二维码URL | 系统生成 |
| **--- 统计信息 ---** ||||
| scan_count | INT | 扫码次数 | 系统统计 |
| register_count | INT | 注册人数 | 系统统计 |
| **--- 缓存信息 ---** ||||
| cache_expire | DATETIME | 缓存过期时间 | 系统计算 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |

**render_data JSON结构**:
```json
{
  "tds_value": 15.5,
  "rank_percentage": 99.2,
  "user_nickname": "张三",
  "user_avatar": "https://..."
}
```

---

### 8.5 wdy_marketing_team (营销团队表)
**用途**: 拼团/组队记录
**保留理由**: 独立业务实体

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 团队ID | 系统生成 |
| activity_id | BIGINT | 活动ID | 关联拼团活动 |
| leader_id | BIGINT | 团长用户ID | 发起用户 |
| team_size | INT | 成团人数 | 活动配置 |
| current_size | INT | 当前人数 | 系统统计 |
| **--- 成员信息 ---** ||||
| members | JSON | 成员列表JSON | 系统记录 |
| **--- 状态信息 ---** ||||
| status | VARCHAR(20) | 状态 | FORMING/SUCCESS/FAILED/EXPIRED |
| expire_time | DATETIME | 过期时间 | 系统计算 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| completed_at | DATETIME | 成团时间 | 系统记录 |

**members JSON结构**:
```json
[
  {"user_id": 1, "nickname": "张三", "join_time": "2024-01-15 10:00:00"},
  {"user_id": 2, "nickname": "李四", "join_time": "2024-01-15 11:00:00"}
]
```

---

## 9️⃣ 平台基础设施 (8张表) 【v4.1增强】

### 【v4.1 P1级补充】
| 新增表 | 说明 | 上线时间 |
|-------|------|---------|
| 🆕 wdy_id_segment | 分布式ID段表，支持订单号、流水号等高并发生成 | P1可选 |

---

### 9.1 wdy_sys_dict (系统字典表) ⭐核心表
**用途**: 统一管理所有枚举、配置、小数据
**合并来源**: wdy_province_code + wdy_partner_type + wdy_category + wdy_config(部分) + 其他配置表

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 字典ID | 系统生成 |
| dict_type | VARCHAR(50) | 字典类型 | 系统定义 |
| dict_code | VARCHAR(50) | 字典编码 | 系统定义 |
| dict_name | VARCHAR(100) | 字典名称 | 后台输入 |
| dict_value | TEXT | 字典值 | 后台输入 |
| parent_id | BIGINT | 父级ID | 层级关系 |
| extra_data | JSON | 扩展数据JSON | 后台配置 |
| sort_order | INT | 排序 | 后台排序 |
| is_active | TINYINT | 是否启用 | 后台管理 |
| remark | VARCHAR(255) | 备注 | 后台输入 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**dict_type枚举示例**:
- `PROVINCE_CODE` - 省份代码(用于UID生成)
- `PARTNER_TYPE` - 合伙人类型
- `ORDER_STATUS` - 订单状态
- `DEVICE_STATUS` - 设备状态
- `PRODUCT_CATEGORY` - 商品分类
- `FAULT_TYPE` - 故障类型
- `BANK_LIST` - 银行列表

**PROVINCE_CODE示例**:
```json
{
  "dict_type": "PROVINCE_CODE",
  "dict_code": "GD",
  "dict_name": "广东省",
  "extra_data": {"region": "华南", "pinyin": "guangdong"}
}
```

**索引设计**:
```sql
CREATE UNIQUE INDEX idx_type_code ON wdy_sys_dict(dict_type, dict_code);
CREATE INDEX idx_parent ON wdy_sys_dict(parent_id);
```

---

### 9.2 wdy_sys_config (系统配置表)
**用途**: 系统级配置项
**保留理由**: 独立配置实体

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 配置ID | 系统生成 |
| config_group | VARCHAR(50) | 配置分组 | 系统定义 |
| config_key | VARCHAR(100) | 配置键 | 系统定义 |
| config_value | TEXT | 配置值 | 后台输入 |
| value_type | VARCHAR(20) | 值类型 | STRING/JSON/NUMBER |
| config_desc | VARCHAR(255) | 配置说明 | 系统定义 |
| is_public | TINYINT | 是否公开 | 后台设置 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**config_group示例**:
- `BASIC` - 基础配置
- `PAYMENT` - 支付配置
- `SMS` - 短信配置
- `MAP` - 地图配置
- `WECHAT` - 微信配置

---

### 9.3 wdy_admin (管理员表)
**用途**: 后台管理员账户
**保留理由**: 核心实体
**v4.2.2优化**: 补充合伙人关联字段,支持合伙人登录后台

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 管理员ID | 系统生成 |
| username | VARCHAR(50) | 用户名 | 后台注册 |
| password | VARCHAR(255) | 密码(加密) | 后台设置 |
| nickname | VARCHAR(50) | 昵称 | 后台输入 |
| avatar | VARCHAR(255) | 头像 | 后台上传 |
| mobile | VARCHAR(20) | 手机号 | 后台输入 |
| email | VARCHAR(100) | 邮箱 | 后台输入 |
| **--- 角色权限 ---** ||||
| role_ids | JSON | 角色ID列表JSON | 后台分配 |
| **--- 合伙人关联 (v4.2.2新增) ---** ||||
| related_partner_id | BIGINT | 关联合伙人ID | 可选,关联wdy_partner表 |
| **--- 状态信息 ---** ||||
| status | TINYINT | 状态 | 0禁用/1启用 |
| last_login_time | DATETIME | 最后登录时间 | 系统记录 |
| last_login_ip | VARCHAR(50) | 最后登录IP | 系统记录 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**设计说明（v4.2.2补充）**:
- **related_partner_id**: 当管理员同时是合伙人时,记录其在wdy_partner表的ID
- **使用场景**: 管理合伙人、区域合伙人等需要后台权限的合伙人
- **权限控制**: 通过role_ids配置该合伙人在后台的操作权限
- **数据隔离**: 合伙人登录后台时,根据related_partner_id限制只能查看自己相关的数据

---

### 9.4 wdy_admin_role (管理员角色表)
**用途**: 角色权限定义
**合并来源**: wdy_auth_group + wdy_auth_rule

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 角色ID | 系统生成 |
| role_name | VARCHAR(50) | 角色名称 | 后台输入 |
| role_desc | VARCHAR(255) | 角色描述 | 后台输入 |
| permissions | JSON | 权限列表JSON | 后台配置 |
| is_active | TINYINT | 是否启用 | 后台管理 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**permissions JSON结构**:
```json
{
  "menus": ["user", "device", "order"],
  "actions": ["user:view", "user:edit", "device:view", "device:cmd"]
}
```

---

### 9.5 wdy_admin_log (管理员操作日志表)
**用途**: 后台操作审计
**保留理由**: 审计需要

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 日志ID | 系统生成 |
| admin_id | BIGINT | 管理员ID | 操作人 |
| action | VARCHAR(100) | 操作动作 | 系统记录 |
| module | VARCHAR(50) | 操作模块 | 系统记录 |
| target_type | VARCHAR(50) | 目标类型 | 业务类型 |
| target_id | BIGINT | 目标ID | 业务ID |
| request_data | JSON | 请求数据JSON | 系统记录 |
| response_data | JSON | 响应数据JSON | 系统记录 |
| ip | VARCHAR(50) | 操作IP | 系统记录 |
| user_agent | VARCHAR(255) | 浏览器信息 | 系统记录 |
| created_at | DATETIME | 操作时间 | 系统生成 |

---

### 9.6 wdy_wechat_config (微信配置表)
**用途**: 微信相关配置
**合并来源**: wdy_weixin_config + wdy_weixin_cache + 部分模板配置

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 配置ID | 系统生成 |
| config_type | VARCHAR(30) | 配置类型 | MINIAPP/OFFICIAL/PAY |
| app_id | VARCHAR(50) | AppID | 微信平台 |
| app_secret | VARCHAR(100) | AppSecret | 微信平台 |
| mch_id | VARCHAR(50) | 商户号 | 微信支付 |
| api_key | VARCHAR(100) | API密钥 | 微信支付 |
| **--- Token缓存 ---** ||||
| access_token | TEXT | AccessToken | 系统刷新 |
| token_expire | DATETIME | Token过期时间 | 系统计算 |
| **--- 模板配置 ---** ||||
| templates | JSON | 消息模板JSON | 后台配置 |
| **--- 其他配置 ---** ||||
| extra_config | JSON | 扩展配置JSON | 后台配置 |
| is_active | TINYINT | 是否启用 | 后台管理 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

---

### 9.7 wdy_stats_daily (统一日统计表) 【✋ 待优化】
**用途**: 统一的日维度统计数据
**合并来源**: wdy_station_daily_stat + wdy_user_daily_stat + wdy_platform_daily_stat + wdy_area_monthly_stat + wdy_partner_income_stat
**v4.2优化**: 添加核心指标独立列，支持排序索引

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID | 系统生成 |
| stat_date | DATE | 统计日期 | 系统生成 |
| stat_type | VARCHAR(30) | 统计类型 | 维度类型 |
| dimension_id | BIGINT | 维度ID | 设备ID/用户ID/区域ID |
| dimension_name | VARCHAR(100) | 维度名称 | 可选 |
| **--- 🆕 核心指标独立列(v4.2优化,支持排序索引) ---** ||||
| order_count | INT | 订单数量 | 系统统计 |
| water_volume | DECIMAL(12,2) | 取水量(升) | 系统统计 |
| income_amount | DECIMAL(12,2) | 收入金额 | 系统统计 |
| **--- 统计指标(JSON灵活存储,存放其他指标) ---** ||||
| metrics | JSON | 其他统计指标JSON | 系统统计 |
| **--- 时间戳 ---** ||||
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**stat_type枚举**:
- `DEVICE` - 设备维度
- `USER` - 用户维度
- `PLATFORM` - 平台维度
- `AREA` - 区域维度
- `PARTNER` - 合伙人维度

**metrics JSON示例（设备维度,存放order_count/water_volume/income_amount之外的指标）**:
```json
{
  "user_count": 50,
  "avg_order_amount": 2.50,
  "peak_hour": 14
}
```

**metrics JSON示例（平台维度）**:
```json
{
  "total_users": 10000,
  "new_users": 50,
  "active_users": 500,
  "total_orders": 2000,
  "total_income": 10000.00,
  "device_online_rate": 95.5
}
```

**索引设计**:
```sql
CREATE UNIQUE INDEX idx_date_type_dim ON wdy_stats_daily(stat_date, stat_type, dimension_id);
CREATE INDEX idx_type_date ON wdy_stats_daily(stat_type, stat_date DESC);
-- 🆕 核心指标排序索引(v4.2优化)
CREATE INDEX idx_order_count ON wdy_stats_daily(stat_type, stat_date, order_count DESC);
CREATE INDEX idx_water_volume ON wdy_stats_daily(stat_type, stat_date, water_volume DESC);
CREATE INDEX idx_income_amount ON wdy_stats_daily(stat_type, stat_date, income_amount DESC);
```

---

### 9.8 wdy_id_segment (分布式ID段表) 🆕 P1级可选
**用途**: 支持分布式场景下的高并发ID生成，用于订单号、流水号等业务号码
**使用场景**: 当单个序列号表不足以支撑高并发时，或多机房部署时
**是否必须**: P1可选，单机部署可不使用

| 字段名 | 字段类型 | 说明 | 来源 |
|-------|--------|------|------|
| id | BIGINT | 记录ID | 系统生成 |
| biz_type | VARCHAR(50) | 业务类型 | 如ORDER、WATER_LOG、COIN_LOG |
| max_id | BIGINT | 当前最大ID | 已分配ID上界 |
| step | INT | 段长度 | 每次分配多少个ID，如1000 |
| version | INT | 乐观锁版本 | 并发控制 |
| description | VARCHAR(255) | 业务描述 | 说明 |
| created_at | DATETIME | 创建时间 | 系统生成 |
| updated_at | DATETIME | 更新时间 | 系统更新 |

**预置业务类型**:
- ORDER - 订单号生成（step=1000）
- WATER_LOG - 取水流水（step=5000）
- COIN_LOG - 水币流水（step=2000）
- PROMOTION_LOG - 促销流水（step=1000）

**设计说明**：
- 应用服务一次获取一个段（如1000个ID），避免每次都请求数据库
- 采用乐观锁+CAS模式，支持多服务器并发申请
- 适用于高并发场景，可与wdy_uid_sequence配合使用

---

## 📊 重构前后对比总结

### 表数量对比（v4.2.2完整修正版）

| 模块 | 重构前 | 重构后(v4.2.2) | 减少 | 主要优化策略 |
|------|--------|--------|------|-------------|
| 用户领域 | 10张 | 8张 | -2张 | v4.2物理拆分:user→user+wallet+token(+2表),合并银行卡表,v4.2.1删除充值审批流 |
| 设备领域 | 14张 | 9张 | -5张 | 合并配置类、统计类表,v4.2.2明确水质监控实现方式 |
| 订单领域 | 11张 | 7张 | -4张 | 统一订单表+多态设计,v4.2.2优化支付记录查询 |
| 合伙人领域 | 13张 | 6张 | -7张 | 合并申请、类型配置,v4.2.1优化数字员工工具,v4.2.2补充账号体系说明 |
| 租赁领域 | 5张 | 3张 | -2张 | 合并缴费、归还到订单,v4.2.2补充归还流程说明 |
| 商品领域 | 6张 | 6张 | 持平 | v4.2物理拆分:order→order+order_item(+1表),合并SKU,v4.2.2补充库存流水表(+1表) |
| 财务领域 | 10张 | 4张 | -6张 | 合并日志类表 |
| 营销领域 | 12张 | 5张 | -7张 | 统一活动表+多态设计 |
| 平台基础设施 | 18张 | 8张 | -10张 | 合并字典表/配置表/微信表/统计表,v4.2.2补充管理员合伙人关联 |
| **总计** | **99张** | **56张** | **-43张** | **精简43%,v4.2完成物理拆分,v4.2.1业务优化,v4.2.2完整修正** |

> **说明**: 平台基础设施合并了原"内容管理"(7张)、"消息通知"(9张)、"系统配置"(7张)的部分表

### v4.2/v4.2.1/v4.2.2版本新增/修改表汇总

| 优先级 | 表名 | 类型 | 说明 | 领域影响 |
|--------|------|------|------|---------|
| P0 | wdy_uid_sequence | 🆕新增 | UID序列号集中管理 | 用户领域 |
| P0 | wdy_user | ✅拆分 | 拆分为user+wallet+token三张表 | 用户领域 |
| P0 | wdy_user_wallet | 🆕新增 | 钱包独立表+balance_lock_version乐观锁,v4.2.1水币字段改为INT | 用户领域 |
| P0 | wdy_user_token | 🆕新增 | Token独立表,解耦认证和业务 | 用户领域 |
| P0 | wdy_user_coin_log | 🔄修改 | v4.2.1水币字段改为INT整数类型 | 用户领域 |
| P0 | wdy_product_order | ✅拆分 | 移除order_items JSON字段 | 商品领域 |
| P0 | wdy_order_item | 🆕新增 | 订单明细独立表,支持精确库存扣减 | 商品领域 |
| P0 | wdy_product_stock_log | 🆕新增 | v4.2.2补充库存流水表,财务对账必需 | 商品领域 |
| P0 | wdy_order | 🔄修改 | v4.2.1优化支付方式说明,明确水币类型 | 订单领域 |
| P0 | wdy_order_payment | 🔄修改 | v4.2.2补充查询优化建议,避免查询大JSON字段 | 订单领域 |
| P0 | wdy_meal | 🔄修改 | v4.2.1水币字段改为INT,补充VIP权益说明 | 订单领域 |
| P0 | wdy_transfer | 🔄修改 | v4.2.1水币字段改为INT | 订单领域 |
| P0 | wdy_promotion_account | 🔄修改 | +version乐观锁字段 | 财务领域 |
| P0 | wdy_partner_ai_tool | 🔄修改 | v4.2.1优化为数字员工工具,支持七种合伙人类型权限 | 合伙人领域 |
| P0 | wdy_device_fault | 🔄修改 | v4.2.2补充水质异常类型,明确与维护记录关联 | 设备领域 |
| P0 | wdy_rental_order | 🔄修改 | v4.2.2补充归还流程说明,明确不建独立归还表 | 租赁领域 |
| P0 | wdy_admin | 🔄修改 | v4.2.2补充related_partner_id字段,支持合伙人登录后台 | 基础设施 |
| P1 | wdy_device_price_history | 🆕新增 | 设备价格变更历史 | 设备领域 |
| P1 | wdy_device_maintenance | 🆕新增 | 设备维护记录,v4.2.2补充故障单关联字段 | 设备领域 |
| P1 | wdy_id_segment | 🆕新增(可选) | 分布式ID段生成 | 基础设施 |
| ❌ | wdy_refill_approval_flow | 🗑️删除 | v4.2.1删除充值审批流程,充值无需审批 | 用户领域 |

**v4.2.1修正版关键更新**:
- 🔧 水币整数化: 所有水币相关字段从DECIMAL改为INT,按门关闭后整数扣费
- 🗑️ 删除充值审批: 用户充值水币无需审批,简化流程
- 🤖 数字员工工具: 优化合伙人工具为数字员工工具,支持API接口配置和七种类型权限管理
- 💳 支付方式优化: 明确取水订单只能用水币支付,显示使用的水币类型
- 🎁 VIP权益明确: 补充超级会员赠送2000水币、五折购买水币等权益说明

**v4.2.2完整修正版关键更新**:
- 📦 补充库存流水表: 新增wdy_product_stock_log,满足财务对账和审计需求
- 💧 明确水质监控: 水质报告动态生成,水质异常复用故障表,避免冗余建表
- 🔄 优化归还流程: 明确租赁归还信息存储在JSON字段,补充损坏评估和押金处理说明
- 🤝 补充账号体系: 明确合伙人前台账号(wdy_user+wdy_partner)和后台账号(wdy_admin)的关联关系
- 🔗 关联故障维护: 故障工单结单时自动生成维护记录,避免重复录入
- ⚡ 查询优化建议: 支付记录表列表页禁止查询大JSON字段,提升查询性能
- 💳 支付方式优化: 明确取水订单只能用水币支付,显示使用的水币类型
- 🎁 VIP权益明确: 补充超级会员赠送2000水币、五折购买水币等权益说明

**v4.2关键突破**:
- ✅ 用户表拆分: 3张独立表,消除死锁风险,支持10000+ QPS
- ✅ 订单明细拆分: 独立表存储,消除库存超卖,支持精确统计
- ✅ 统计表优化: 核心指标(order_count/water_volume/income_amount)独立列+排序索引

**v4.2.1修正版突破**:
- 🔧 水币整数化: 统一为INT类型,门关闭后按整数扣费,避免精度问题
- 🗑️ 流程简化: 删除充值审批流程,提升用户体验
- 🤖 工具升级: 数字员工工具支持API接口和多类型权限,赋能合伙人

### 核心设计亮点

1. **聚合根明确**
   - 8个领域聚合根边界清晰
   - 跨聚合只通过ID关联

2. **✅ 物理拆分落地（v4.2关键成果）**
   - 用户表3表拆分: 身份/钱包/认证完全解耦,消除死锁
   - 订单明细独立: 支持精确库存管理和销量统计
   - 执行策略: 从方案到实际SQL结构的完整落地

3. **JSON字段合理使用**
   - 1:1关系数据合并到主表JSON
   - 配置类数据用JSON存储
   - 多态业务数据用JSON扩展
   - ⚠️ 核心交易数据不使用JSON(已拆分为独立表)

4. **统一字典表**
   - 所有枚举、配置、小数据统一管理
   - 减少10+张配置小表

5. **✅ 统一统计表（v4.2优化完成）**
   - 多维度统计数据一张表
   - 用type+dimension_id区分
   - 核心指标(order_count/water_volume/income_amount)使用独立列+排序索引
   - 其他扩展指标用metrics JSON灵活存储

6. **保持3NF的核心数据**
   - 订单、流水等核心交易数据独立
   - 订单明细物理拆分,支持原子性操作
   - 审计日志完整保留

7. **🆕 并发控制与安全（v4.2强化,v4.2.1优化）**
   - UID序列号: 单表集中管理+悲观锁,防重复支持高并发
   - 账户扣费: 乐观锁+存储过程确保原子性（balance_lock_version、version）
   - 敏感数据: AES加密存储+脱敏JSON展示,防泄露
   - 水币整数化: INT类型存储,避免精度问题,门关闭后整数扣费
   - ID生成: 支持分布式场景的高性能ID段管理
   - 表结构拆分: 热点数据独立表,避免行锁竞争

---

## 🎯 实施建议

### Phase 0: 关键机制补充 (上线前必须完成，预计3-5人天)

**P0级上线必须项**:
1. ✅ 创建wdy_uid_sequence表 + 部署sp_generate_uid存储过程
   - 解决UID并发生成问题，防止重复
   - 预置32个省份代码记录
   
2. ✅ wdy_user_wallet表增加balance_lock_version字段 + 部署sp_deduct_water_coins存储过程
   - 实现三账户(recharge_coin, give_coin, reward_coin)扣费的原子性
   - 支持扣费重试和乐观锁冲突处理
   - ⚠️ 注意: 该字段在wdy_user_wallet表，不是wdy_user表
   
3. ✅ wdy_user表bank_info改为AES加密存储 + bank_info_masked脱敏JSON
   - 部署数据库端加密函数(AES_ENCRYPT/AES_DECRYPT)
   - 数据迁移：逐条加密转移，生成脱敏版本
   
4. ✅ wdy_promotion_account表增加version字段 + 部署sp_deduct_promotion_balance存储过程
   - 促销账户扣费的并发控制，支持乐观锁
   
5. ✅ 部署敏感数据加密/脱敏函数
   - 应用层调用统一的加密解密接口
   - 避免敏感数据在日志和查询结果中泄露

6. ✅ 水币字段整数化迁移 (v4.2.1新增)
   - 修改wdy_user_wallet表: recharge_coin/give_coin/reward_coin字段从DECIMAL(10,2)改为INT
   - 修改wdy_user_coin_log表: amount/balance_before/balance_after字段改为INT
   - 修改wdy_meal表: coin_amount/give_amount字段改为INT
   - 修改wdy_transfer表: amount字段改为INT
   - 数据迁移: 小数部分四舍五入转整数
   - 业务调整: 门关闭后按整数水币扣费，不再支持小数

**关键验证**:
- 高并发压力测试(最少1000QPS并发UID生成)
- 账户扣费原子性测试(模拟网络异常、重复请求)
- 加密数据完整性和脱敏效果验证

### Phase 1: 基础设施 (第1周)
1. 创建wdy_sys_dict字典表，迁移配置数据
2. 创建wdy_sys_config配置表
3. 创建wdy_admin相关表

### Phase 2: 核心领域 (第2-3周)
1. 重构wdy_user用户表(拆分为user/wallet/token三表)
2. 重构wdy_device设备表(合并配置)
3. 重构wdy_order统一订单表
4. 重构wdy_product_order商品订单(拆分订单明细到wdy_order_item)

### Phase 3: 业务领域 (第4-5周)
1. 重构wdy_partner合伙人表
2. 重构wdy_rental租赁表
3. 重构wdy_product商品表

### Phase 4: 营销财务 (第6周)
1. 重构wdy_promotion_account促销账户
2. 重构wdy_marketing_activity营销活动
3. 重构wdy_stats_daily统一统计

### 数据迁移注意事项
- 每个Phase完成后进行数据验证
- 保留原表作为备份，新旧并行运行1周
- 使用视图兼容旧查询语句
- 分批迁移历史数据

---

**文档版本**: v4.2.2 DDD优化版（物理拆分+业务优化+完整修正版）  
**生成时间**: 2025-12-21  
**总表数**: 56张（从99张精简43%）  
**设计原则**: DDD聚合根 + 3NF + 三大黄金法则 + 物理拆分 + 并发安全 + 敏感数据加密  
**v4.2关键突破**: ✅ 用户表3表物理拆分、✅ 订单明细独立表、✅ 统计表核心列优化、P0级并发控制、P0级安全加密、P1级历史管理  
**v4.2.1修正**: 🔧 水币整数化、🗑️ 删除充值审批流程、🤖 数字员工工具升级、💳 支付方式优化、🎁 VIP权益明确  
**v4.2.2完整修正**: 📦 补充库存流水表、💧 明确水质监控实现、🔄 优化归还流程说明、🤝 补充合伙人账号体系、🔗 关联故障维护记录、⚡ 查询性能优化建议
