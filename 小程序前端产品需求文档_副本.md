这是一份基于你提供的《数据库重构方案v4.2.2》、《小程序功能总览》和《后台管理系统PRD》整理的小程序前端产品需求开发文档。

这份文档重点聚焦于你要求的**新增功能**（专享服务、合伙人升级）和**优化功能**（水质展示、VIP逻辑、分享裂变），并严格对齐了数据库结构。

---

# 小程序前端产品需求开发文档 (v2.0 增量版)

**文档版本**：v2.0

**更新日期**：2025年12月21日

**适用端**：微信小程序 / uni-app

**核心目标**：完善商业化服务闭环（租赁/售卖），深度赋能合伙人（移动端管理/AI工具），并优化核心C端用户体验（水质可视化/VIP权益）。

---

## 1. 🆕 新增功能模块：专享服务 (Service Store)

**功能定位**：为用户提供除“取水”之外的增值服务，包括设备租赁、上门安装及周边商品购买。

### 1.1 页面展示与逻辑

* **入口**：首页金刚区新增“专享服务”图标，或底部Tab栏（视UI布局定）。
* **列表页**：
* 顶部Tab切换：**设备租赁** | **安装服务** | **好物甄选**。
* 商品卡片展示：缩略图、名称、价格（租金/日 或 售价）、标签（如“包安装”、“现货”）。
* **数据来源**：调用商品列表接口，筛选 `wdy_product` 表。
* 租赁：`product_type = 'RENTAL'`
* 安装：`product_type = 'SERVICE'`
* 甄选：`product_type = 'SALE'`





### 1.2 订单详情优化

* **需求描述**：在原有的订单详情页中，增加对上述三种新业务类型的支持。
* **展示内容**：
* **通用信息**：订单号、状态、金额、下单时间。
* **租赁单特有** (`order_type='RENTAL'`)：租赁周期、押金状态（已交/已退）、起止日期、归还入口。
* **服务单特有** (`order_type='INSTALL'`)：预约上门时间、联系人信息、安装师傅（若已分配）。
* **实物单特有** (`order_type='PRODUCT'`)：物流信息（快递单号）、收货地址。


* **数据库交互**：
* 查询 `wdy_order` 主表获取基础信息。
* 关联查询 `wdy_order_item` 获取商品明细（名称、图片、数量）。
* 关联查询 `wdy_rental_order` (若是租赁) 获取押金和租期信息。



### 1.3 用户操作旅程

> 1. 用户进入“专享服务”页面，点击“TDS水质检测笔”。
> 2. 查看详情，点击“立即购买”，选择收货地址（调用 `wdy_user` 下关联的地址库）。
> 3. 支付成功（微信/支付宝），生成 `PRODUCT` 类型订单。
> 4. 用户在“我的-订单”中查看发货状态。
> 
> 

---

## 2. 🆕 新增功能模块：合伙人工作台 (Partner Hub)

**功能定位**：合伙人的移动端管理中心，根据合伙人类型动态展示权限。

### 2.1 合伙人详情与标签

* **页面位置**：我的 -> 合伙人中心（仅合伙人身份可见）。
* **头部卡片**：
* 展示合伙人姓名、头像。
* **合伙人标签**：根据 `wdy_partner.partner_type` 动态渲染标签（如“营销合伙人”、“地址合伙人”）。
* 累计收益、可提现金额（数据源：`wdy_user_wallet.money`）。



### 2.2 数字员工与工具箱

* **功能描述**：根据合伙人类型，展示被授权使用的AI工具。
* **展示逻辑**：
* 调用接口获取当前合伙人被授权的工具列表（关联 `wdy_partner_ai_tool` 和 `allowed_partner_types`）。
* **拼团工具**：仅对有权限的合伙人展示。点击进入拼团发起页面，配置团购参数（关联 `wdy_marketing_activity`）。
* **数字员工（海报生成）**：
1. 用户输入/选择参数（如：推广语、关联设备）。
2. 前端调用后台AI接口。
3. 返回生成的海报图片，支持保存相册。




* **数据需求**：需要后台提供 `GET /api/partner/tools` 接口，返回工具Icon、名称、跳转路径。

### 2.3 业务管理：我的设备

* **功能描述**：查看合伙人名下绑定的设备资产详情。
* **列表项展示**：设备名称、当前状态（在线/离线）、今日收益。
* **详情页展示字段**（对应 `wdy_partner_device` 表）：
* **安装日期** (`install_date`)
* **安装位置** (`install_location`)
* **签约周期** (`contract_start_date` 至 `contract_end_date`)
* **联系方式** (`contact_name`, `contact_phone`)
* **签约价格** (`contract_price`)
* **当前分润比例** (`profit_rate`)



### 2.4 管理合伙人特权功能

> **注意**：以下功能仅当 `partner_type = 'MANAGEMENT'` 时显示。

* **租赁管理（收费标准设置）**：
* 列表展示管辖区域内的租赁设备。
* 操作：点击设备 -> 设置收费标准。
* **数据提交**：更新 `wdy_rental_product` 或 `wdy_device.charging_config` (需确认是设置机器的租赁价还是售水价，根据上下文推测是**设备租赁定价**)。
* *待确认事项*：通常定价权在平台，需确认管理合伙人是否有权直接修改数据库中的金额字段。


* **审批管理**：
* 展示待审批列表（如：下级合伙人申请、特殊退款审批）。
* **操作**：通过 / 驳回 / 填写意见。
* **数据源**：`wdy_partner_apply` (合伙人申请) 或 `wdy_withdrawals` (如果授权合伙人审批提现)。



---

## 3. ⚡ 优化功能模块

### 3.1 分享好友裂变 (Viral Features)

* **优化点**：
1. **分享海报**：调用 `wdy_poster` 表中启用的模板，动态合成用户头像和二维码。
2. **抽奖活动**：
* 新增“转盘抽奖”或“扫码抽奖”入口。
* 逻辑：用户扫设备码或分享码后，触发前端抽奖动画。
* 结果：调用后台抽奖接口，中奖后直接发放“奖励水币” (`wdy_user_wallet.reward_coin`)。
* **数据源**：`wdy_marketing_activity` (类型=`LUCKY_DRAW`)。





### 3.2 实时水质检测展示 (Real-time Water Quality)

* **场景**：用户扫码开门/准备取水时。
* **页面交互**：
* 在“取水控制”或“设备详情”页面显著位置展示水质仪表盘。
* **核心指标**：TDS值、温度、浊度。
* **评价**：显示“优/良/差”标签。


* **数据获取**：
* 接口需透出 `wdy_device_quality` 表中该设备最新的一条记录 (`order by created_at desc limit 1`)。
* 或者读取 `wdy_device` 表中的 `realtime_quality` JSON缓存字段（推荐，速度快）。



### 3.3 首页视觉升级

* **轮播图**：
* 支持视频流播放（自动静音播放，点击全屏）。
* 数据源：`wdy_marketing_activity` 或 `wdy_sys_config` 中的轮播配置，需区分 `media_type` (IMAGE/VIDEO)。



### 3.4 套餐拼团权限控制

* **逻辑变更**：首页的“拼团活动”入口对普通用户**隐藏**或**置灰**。
* **鉴权逻辑**：
* 接口返回用户身份信息。
* 前端判断：`if (user.is_partner == true)` 显示拼团入口；`else` 隐藏。
* *目的*：拼团可能作为合伙人拉新的工具，而非直接对C端开放。



### 3.5 购买水币与VIP权益 (Membership Logic)

* **购买水币页面**：
* **UI优化**：显著标示“VIP会员专享价 0.025元/币”（普通价0.05元）。
* **开通引导**：若用户非VIP，在支付栏上方增加“开通VIP立送2000水币”的勾选框或Banner。


* **VIP办理逻辑**：
* 用户购买VIP（¥198/年）。
* 前端展示：支付成功页弹窗提示“恭喜成为VIP，2000赠送水币已到账”。
* **数据变化**：
* `wdy_user.vip_status` = 1
* `wdy_user_wallet.give_coin` + 2000




* **支付协议补充**：
* 在支付确认弹窗底部增加《付费会员服务协议》和《水币充值与使用规则》链接。
* 重点提示：水币一经充值/赠送，除法律规定外不予提现；VIP赠送币不可退款。



---

## 4. 📝 数据交互需求 (API Requirements)

为了实现上述前端功能，需要后台配合提供以下数据接口：

### 4.1 专享服务相关

| 接口描述 | 请求参数 | 响应关键字段 | 关联表 |
| --- | --- | --- | --- |
| **获取商品列表** | `type` (RENTAL/SERVICE/SALE) | `id`, `name`, `price`, `images`, `stock` | `wdy_product` |
| **创建商品订单** | `product_id`, `qty`, `address_id` | `order_sn`, `pay_params` | `wdy_order`, `wdy_order_item` |

### 4.2 合伙人相关

| 接口描述 | 请求参数 | 响应关键字段 | 关联表 |
| --- | --- | --- | --- |
| **获取合伙人信息** | `token` | `partner_type`, `total_income`, `labels` | `wdy_partner` |
| **获取我的设备** | `partner_id` | `install_date`, `contract_price`, `location` | `wdy_partner_device` |
| **获取可用AI工具** | `partner_type` | `tool_name`, `icon`, `api_endpoint` | `wdy_partner_ai_tool` |
| **提交租赁定价** | `device_id`, `config_json` | `status` | `wdy_device` |
| **获取审批列表** | `status` | `apply_id`, `applicant`, `content` | *(需确认具体审批表)* |

### 4.3 核心体验相关

| 接口描述 | 请求参数 | 响应关键字段 | 关联表 |
| --- | --- | --- | --- |
| **获取设备实时水质** | `device_id` | `tds`, `turbidity`, `update_time`, `evaluation` | `wdy_device_quality` |
| **获取VIP权益信息** | `none` | `price_discount`, `gift_coin_amount` | `wdy_sys_config` |

---

## 5. 待确认事项 (To Be Confirmed)

1. **租赁定价权限**：管理合伙人设置收费标准是直接生效，还是需要平台二次审核？
2. **审批具体内容**：管理合伙人具体负责哪几类审批（入驻审批？提现审批？）当前数据库中删除了充值审批，需明确。
3. **检测工具售卖**：是否需要对接物流查询API（如快递100），还是仅记录单号？

---

**用户操作旅程示例 (合伙人视角)**：

> 李四（营销合伙人）打开小程序 -> 进入“合伙人中心” -> 看到“营销合伙人”标签 -> 点击“数字员工” -> 选择“活动海报生成” -> 输入“周末社区送水活动” -> 生成海报并保存 -> 点击“拼团工具” -> 发起一个“9.9元水卡团” -> 分享海报到微信群 -> 在“我的设备”中查看昨天绑定的设备安装进度。